<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LMS - Learning Management System</title>
  <!-- Plus Jakarta Sans - Modern Tech Font -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ================= DEEP DARK + GLASSMORPHISM DESIGN SYSTEM ================= */

    :root {
      /* Deep Dark Color Palette */
      --bg-950: #050507;
      --bg-900: #09090B;
      --bg-800: #121216;
      --bg-700: #18181B;
      --border: #1F1F23;
      --border-light: #27272A;

      /* Text Colors */
      --text-primary: #FAFAFA;
      --text-secondary: #A1A1AA;
      --text-muted: #71717A;

      /* Brand & Accent */
      --brand-red: #DC2626;
      --brand-red-light: #EF4444;
      --glow-red: rgba(220, 38, 38, 0.3);
      --glow-red-intense: rgba(220, 38, 38, 0.5);

      /* Semantic Colors */
      --success: #22C55E;
      --success-bg: rgba(34, 197, 94, 0.1);
      --warning: #EAB308;
      --warning-bg: rgba(234, 179, 8, 0.1);
      --info: #3B82F6;
      --info-bg: rgba(59, 130, 246, 0.1);
      --error: #EF4444;
      --error-bg: rgba(239, 68, 68, 0.1);

      /* Gradients */
      --gradient-red: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
      --gradient-sidebar-active: linear-gradient(90deg, rgba(220, 38, 38, 0.15) 0%, transparent 100%);

      /* Glass Effect */
      --glass-bg: rgba(18, 18, 22, 0.8);
      --glass-border: rgba(255, 255, 255, 0.05);

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 20px var(--glow-red);

      /* Transitions */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-900);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-700);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-light);
    }

    body {
      font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-950);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #app {
      position: relative;
      z-index: 1;
    }

    /* ============ TOPBAR (Student Layout) ============ */
    .topbar {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--glass-bg);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar-left {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .topbar-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* ============ TYPOGRAPHY ============ */
    .topbar h2,
    .auth-title,
    .modal-title,
    h3 {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 700;
      color: var(--text-primary);
    }

    .topbar h2 {
      font-size: 24px;
    }

    /* ============ FOCUS MODE HEADER ============ */
    .focus-header {
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: var(--bg-950);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .focus-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--bg-800);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-circle:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
    }

    /* ============ FOCUS LAYOUT ============ */
    .lesson-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      min-height: calc(100vh - 64px);
    }

    @media (max-width: 1024px) {
      .lesson-layout {
        grid-template-columns: 1fr;
      }
    }

    .lesson-main {
      background: var(--bg-950);
      padding: 40px 24px;
      /* More vertical space, standard horizontal */
      display: flex;
      flex-direction: column;
      gap: 32px;
      max-width: 1100px;
      /* Slightly narrower for better focus */
      margin: 0 auto;
      width: 100%;
    }

    .lesson-sidebar {
      background: var(--bg-900);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 64px);
      position: sticky;
      top: 64px;
    }

    /* ============ VIDEO PLAYER (STABLE) ============ */
    .video-container {
      position: relative;
      width: 100%;
      background: black;
      aspect-ratio: 16/9;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border);
    }

    /* Block Pop-out button on Google Drive Video */
    .video-controls-blocker {
      position: absolute;
      top: 0;
      right: 0;
      width: 140px;
      /* Increased to ensure coverage */
      height: 100px;
      z-index: 50;
      /* Super high to stay above iframe */
      background: transparent;
      cursor: default;
    }

    /* ============ HERO & OVERVIEW ============ */
    .hero-section {
      padding: 40px 4% 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .hero-welcome {
      margin-bottom: 32px;
    }

    .hero-title {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #fff 0%, #aaa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }

    .hero-subtitle {
      color: var(--text-muted);
      font-size: 16px;
    }

    /* QUICK STATS */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 40px;
    }

    .stat-box {
      background: var(--bg-800);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: var(--transition);
    }

    .stat-box:hover {
      border-color: var(--brand-red);
      transform: translateY(-2px);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(220, 38, 38, 0.1);
      color: var(--brand-red);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-info h4 {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      line-height: 1;
    }

    .stat-info p {
      font-size: 13px;
      color: var(--text-muted);
      margin: 4px 0 0;
    }

    /* FEATURED COURSE (LAST VIEWED) */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding: 0 4%;
      max-width: 1400px;
      margin: 0 auto 24px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .featured-card {
      background: var(--bg-800);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      margin: 0 4% 40px;
      max-width: 1400px;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      transition: var(--transition);
    }

    .featured-card:hover {
      border-color: var(--brand-red);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .featured-thumb {
      width: 45%;
      min-height: 280px;
      object-fit: cover;
      position: relative;
    }

    .featured-content {
      flex: 1;
      padding: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .featured-badge {
      display: inline-block;
      padding: 6px 12px;
      background: rgba(220, 38, 38, 0.2);
      color: var(--brand-red);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 16px;
      width: fit-content;
    }

    @media (max-width: 768px) {
      .featured-card {
        flex-direction: column;
      }

      .featured-thumb {
        width: 100%;
        height: 200px;
      }

      .featured-content {
        padding: 24px;
      }

      .hero-section {
        padding: 24px 4% 0;
      }
    }

    .play-btn-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: white;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
      transition: transform 0.3s, background 0.3s;
    }

    .video-overlay:hover .play-btn-large {
      transform: scale(1.1);
      background: rgba(220, 38, 38, 0.8);
      border-color: transparent;
    }

    /* ============ PLAYLIST SIDEBAR ============ */
    .playlist-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .playlist-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .playlist-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      opacity: 0.7;
    }

    .playlist-item:hover {
      background: var(--bg-800);
      opacity: 1;
    }

    .playlist-item.active {
      background: var(--bg-800);
      border: 1px solid rgba(220, 38, 38, 0.5);
      opacity: 1;
    }

    .playlist-item.locked {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    .playlist-item.checked {
      opacity: 0.6;
    }

    .playlist-item.checked:hover {
      opacity: 1;
    }

    .playlist-status {
      width: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .playlist-info {
      flex: 1;
    }

    .playlist-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .playlist-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .playlist-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
      background: var(--bg-900);
      position: sticky;
      bottom: 0;
    }

    /* ============ BENTO TABS (BELOW VIDEO) ============ */
    .bento-tabs {
      padding: 24px;
    }

    .tab-header {
      display: flex;
      gap: 24px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }

    .tab-btn {
      padding: 12px 0;
      background: none;
      border: none;
      color: var(--text-muted);
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      position: relative;
      transition: var(--transition);
    }

    .tab-btn:hover {
      color: var(--text-primary);
    }

    .tab-btn.active {
      color: var(--brand-red);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--brand-red);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    /* Material Card */
    .material-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-800);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: var(--transition);
      text-decoration: none;
    }

    .material-card:hover {
      border-color: var(--brand-red);
      transform: translateY(-2px);
    }

    .file-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .live-badge {
      padding: 6px 12px;
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid var(--brand-red);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 800;
      color: var(--brand-red);
      display: flex;
      align-items: center;
      gap: 6px;
      animation: pulse-live 2s infinite;
      letter-spacing: 1px;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--brand-red);
      border-radius: 50%;
      animation: blink-dot 1s infinite;
    }

    @keyframes pulse-live {

      0%,
      100% {
        box-shadow: 0 0 5px rgba(220, 38, 38, 0.4);
      }

      50% {
        box-shadow: 0 0 15px rgba(220, 38, 38, 0.7);
      }
    }

    @keyframes blink-dot {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.4;
      }
    }

    .user-info {
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 13px;
    }

    /* ============ BUTTONS ============ */
    .btn {
      padding: 10px 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-800);
      color: var(--text-primary);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn:hover {
      border-color: var(--border-light);
      background: var(--bg-700);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-800);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-sm:hover {
      background: var(--bg-700);
      color: var(--text-primary);
    }

    .btn-red {
      background: var(--gradient-red);
      border: none;
      color: white;
      box-shadow: 0 0 15px var(--glow-red);
    }

    .btn-red:hover {
      box-shadow: 0 0 25px var(--glow-red-intense);
      transform: translateY(-1px);
    }

    .btn-logout {
      padding: 8px 16px;
      font-size: 12px;
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error);
      background: transparent;
    }

    .btn-logout:hover {
      background: var(--error-bg);
      border-color: var(--error);
    }

    .btn-teacher,
    .form-btn {
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      background: var(--gradient-red);
      color: white;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 0 15px var(--glow-red);
    }

    .btn-teacher:hover,
    .form-btn:hover {
      box-shadow: 0 0 25px var(--glow-red-intense);
      transform: translateY(-1px);
    }

    /* ============ AUTH CONTAINER (Login/Register) ============ */
    .auth-container {
      max-width: 420px;
      margin: 80px auto;
      background: var(--bg-800);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      box-shadow: var(--shadow-lg);
    }

    .auth-title {
      font-size: 28px;
      text-align: center;
      margin-bottom: 32px;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-900);
      color: var(--text-primary);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 14px;
      transition: var(--transition);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--brand-red);
      box-shadow: 0 0 0 3px var(--glow-red);
      background: var(--bg-800);
    }

    textarea.form-input {
      resize: vertical;
      min-height: 100px;
    }

    .form-btn {
      width: 100%;
      padding: 16px;
      margin-top: 24px;
      font-size: 16px;
      border-radius: 12px;
    }

    .form-link {
      text-align: center;
      margin-top: 24px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .form-link a {
      color: var(--brand-red);
      text-decoration: none;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .form-link a:hover {
      color: #F87171;
      text-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
    }

    .alert {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
      font-size: 14px;
      text-align: center;
      font-weight: 600;
    }

    .alert-success {
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid var(--brand-red);
      color: var(--brand-red);
    }

    .alert-error {
      background: rgba(255, 50, 50, 0.1);
      border: 1px solid #ff0000;
      color: #ff4444;
    }

    /* ============ MODALS ============ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
      backdrop-filter: blur(8px);
    }

    .modal-overlay.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-800);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 800px;
      width: 100%;
      margin: 40px auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .modal-title {
      font-size: 24px;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border: 2px solid var(--border-light);
      border-radius: 50%;
      background: transparent;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--brand-red);
      border-color: var(--brand-red);
      color: white;
      transform: rotate(90deg);
      box-shadow: var(--glow-red);
    }

    .lesson-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      position: relative;
    }

    .lesson-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .lesson-title {
      color: var(--text-light);
      font-weight: 800;
      font-size: 18px;
      text-transform: uppercase;
    }

    .btn-remove {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid #ff4444;
      background: rgba(255, 0, 0, 0.1);
      color: #ff4444;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }

    .btn-remove:hover {
      background: #ff4444;
      color: white;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
    }

    .btn-add-lesson {
      border: 2px dashed var(--border-light);
      background: transparent;
      color: var(--text-muted);
      padding: 16px;
      font-weight: 700;
    }

    .btn-add-lesson:hover {
      background: rgba(220, 38, 38, 0.05);
      border-color: var(--brand-red);
      color: var(--brand-red);
    }

    .file-input-group {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-pick-file {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid var(--border-light);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-light);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
    }

    .btn-pick-file:hover {
      border-color: var(--brand-red);
      color: var(--brand-red);
      background: rgba(220, 38, 38, 0.1);
    }

    .info-box {
      background: rgba(220, 38, 38, 0.05);
      border-left: 4px solid var(--brand-red);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .info-box-title {
      color: var(--brand-red);
      font-weight: 800;
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    .info-box-content {
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.6;
    }

    code {
      background: rgba(0, 0, 0, 0.5);
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      display: block;
      white-space: pre;
      overflow-x: auto;
      border: 1px solid var(--border-light);
    }

    /* ============ COURSE GRID ============ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
    }

    .card {
      background: var(--bg-800);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      border-color: var(--border-light);
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);
    }

    .thumb {
      width: 100%;
      height: 180px;
      object-fit: cover;
      background: var(--bg-700);
      border-radius: 12px 12px 0 0;
      position: relative;
      border-bottom: 1px solid var(--border);
      transition: var(--transition);
    }

    .card:hover .thumb {
      opacity: 0.9;
    }

    .card.locked {
      pointer-events: none;
      opacity: 0.5;
    }

    .card.locked .course-actions {
      display: none !important;
    }

    .locked-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #999;
      font-weight: 800;
      font-size: 20px;
      text-transform: uppercase;
      z-index: 5;
      backdrop-filter: blur(2px);
    }

    .locked-icon {
      font-size: 40px;
      margin-bottom: 10px;
      color: #555;
    }

    .card h3 {
      font-size: 16px;
      font-weight: 700;
      margin: 16px 16px 8px;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .card:hover h3 {
      color: var(--text-primary);
    }

    .muted {
      color: var(--text-muted);
      font-size: 13px;
      margin: 0 16px 16px;
      font-weight: 400;
      line-height: 1.5;
    }

    .course-actions {
      display: none;
      position: absolute;
      top: 16px;
      right: 16px;
      gap: 12px;
      z-index: 10;
    }

    .card:hover .course-actions {
      display: flex;
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      border: 1px solid var(--border-light);
      background: rgba(0, 0, 0, 0.5);
      color: var(--text-light);
    }

    .btn-refresh:hover {
      background: #10b981;
      border-color: #10b981;
      color: white;
      box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
      transform: scale(1.1);
    }

    .btn-edit:hover {
      background: var(--brand-red);
      border-color: var(--brand-red);
      color: white;
      box-shadow: var(--glow-red);
      transform: scale(1.1);
    }

    .btn-delete:hover {
      background: #ff0000;
      border-color: #ff0000;
      color: white;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
      transform: scale(1.1);
    }

    h3 {
      color: var(--text-light);
      font-size: 24px;
      font-weight: 800;
      margin: 40px 0 24px;
      background: none;
      -webkit-text-fill-color: initial;
    }

    .lesson-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 32px;
    }

    .lesson {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .lesson:hover {
      border-color: var(--brand-red);
      box-shadow: 0 5px 20px rgba(220, 38, 38, 0.2);
      transform: translateY(-4px);
      background: rgba(220, 38, 38, 0.05);
    }

    .lesson .muted {
      color: var(--brand-red);
      font-weight: 700;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 12px;
    }

    .lesson>div:last-child {
      color: var(--text-light);
      font-size: 16px;
      font-weight: 700;
    }

    #playerWrap {
      position: relative;
      width: 100%;
      user-select: none;
      margin-top: 32px;
    }

    #playerWrap iframe {
      width: 100%;
      height: 600px;
      border: 1px solid var(--border-light);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    }

    .video-controls-blocker {
      background: linear-gradient(to left, #050505 0%, rgba(5, 5, 5, 0) 100%);
      border-top-right-radius: 20px;
    }

    .video-security-notice {
      background: rgba(220, 38, 38, 0.2);
      border: 1px solid var(--brand-red);
      color: var(--brand-red);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 10px 20px;
      border-radius: 50px;
      bottom: 30px;
    }

    a {
      color: var(--text-light);
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
      display: inline-block;
      padding: 12px 24px;
      border: 1px solid var(--border-light);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 14px;
    }

    a:hover {
      background: var(--brand-red);
      border-color: var(--brand-red);
      color: white;
      box-shadow: var(--glow-red);
    }

    #courseDesc {
      background: rgba(255, 255, 255, 0.03);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 32px;
      color: var(--text-muted);
      font-size: 16px;
      line-height: 1.6;
      border: 1px solid var(--border-light);
    }

    #loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--brand-red);
      font-size: 24px;
      z-index: 9999;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: var(--glow-red);
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(-50%) translateX(0);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translateX(-50%) translateX(-10px);
      }

      20%,
      40%,
      60%,
      80% {
        transform: translateX(-50%) translateX(10px);
      }
    }

    /* ================= TOAST NOTIFICATIONS ================= */
    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      background: #1e1e1e;
      /* Hardcoded dark bg to match potential dark mode */
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
      min-width: 320px;
      max-width: 450px;
      color: #fff;
      font-size: 14px;
      pointer-events: auto;
      backdrop-filter: blur(10px);
    }

    .toast.success {
      border-left: 4px solid #22c55e;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .toast.info {
      border-left: 4px solid #3b82f6;
    }

    /* Blue */
    .toast.warning {
      border-left: 4px solid #f59e0b;
    }

    /* Yellow */

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOutUp {
      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }


    /* ================= ADMIN DASHBOARD - DEEP DARK + GLASSMORPHISM ================= */

    .admin-layout {
      display: flex;
      height: 100vh;
      background: var(--bg-950);
      color: var(--text-primary);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 2000;
    }

    /* Sidebar */
    .admin-sidebar {
      width: 260px;
      background: var(--bg-900);
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      flex-shrink: 0;
    }

    .admin-logo {
      height: 64px;
      display: flex;
      align-items: center;
      padding: 0 24px;
      font-weight: 700;
      font-size: 18px;
      color: var(--brand-red);
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    .admin-menu {
      padding: 16px 0;
      flex: 1;
      overflow-y: auto;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      color: var(--text-muted);
      cursor: pointer;
      transition: var(--transition);
      font-size: 14px;
      font-weight: 500;
      position: relative;
    }

    .menu-item:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.02);
    }

    .menu-item.active {
      color: var(--brand-red);
      background: var(--gradient-sidebar-active);
    }

    .menu-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--brand-red);
      border-radius: 0 2px 2px 0;
    }

    .menu-icon {
      width: 20px;
      text-align: center;
      font-size: 16px;
    }

    .admin-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-950);
    }

    .admin-header {
      height: 64px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      background: var(--bg-900);
    }

    .admin-content {
      padding: 32px;
      overflow-y: auto;
      flex: 1;
    }

    .admin-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 24px;
      color: var(--text-primary);
    }

    /* ============ GLASS CARDS (Bento Grid) ============ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 28px;
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      background: var(--bg-800);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
      transition: var(--transition);
    }

    .stat-card:hover {
      border-color: var(--brand-red);
      transform: translateY(-4px);
      box-shadow: 0 10px 30px -10px rgba(220, 38, 38, 0.2);
    }

    /* Background Watermark Icon */
    .stat-card .stat-icon-bg {
      position: absolute;
      right: -10px;
      bottom: -10px;
      width: 100px;
      height: 100px;
      opacity: 0.05;
      transition: var(--transition);
      pointer-events: none;
    }

    .stat-card:hover .stat-icon-bg {
      opacity: 0.1;
      transform: scale(1.1);
    }

    /* Top Icon (Small badge) */
    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-bottom: 8px;
      align-self: flex-start;
    }

    .stat-icon.purple {
      background: rgba(168, 85, 247, 0.1);
      color: #a855f7;
    }

    .stat-icon.yellow {
      background: rgba(234, 179, 8, 0.1);
      color: #eab308;
    }

    .stat-icon.green {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }

    .stat-icon.blue {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .stat-icon.red {
      background: rgba(220, 38, 38, 0.1);
      color: var(--brand-red);
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 40px;
      font-weight: 900;
      color: var(--text-primary);
      line-height: 1;
      margin-bottom: 8px;
    }

    .stat-trend {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    /* Progress Bar at bottom */
    .stat-progress {
      width: 100%;
      height: 4px;
      background: var(--bg-700);
      border-radius: 10px;
      overflow: hidden;
      margin-top: auto;
    }

    .stat-progress-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 0.6s ease;
    }

    .stat-progress-fill.purple {
      background: #a855f7;
    }

    .stat-progress-fill.yellow {
      background: #eab308;
    }

    .stat-progress-fill.green {
      background: #22c55e;
    }

    .stat-progress-fill.blue {
      background: #3b82f6;
    }

    .stat-progress-fill.red {
      background: var(--brand-red);
    }

    /* ============ DATA TABLE ============ */
    .table-card {
      background: var(--bg-800);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }

    .data-table th {
      padding: 14px 24px;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-900);
    }

    .data-table td {
      padding: 14px 24px;
      color: var(--text-secondary);
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    /* ============ STATUS BADGES ============ */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-active {
      background: var(--success-bg);
      color: var(--success);
    }

    .status-inactive {
      background: var(--error-bg);
      color: var(--error);
    }

    .status-pending {
      background: var(--warning-bg);
      color: var(--warning);
    }

    /* ============ CHART STYLES ============ */
    .chart-period {
      background: var(--bg-700);
      border: none;
      color: var(--text-muted);
    }

    .chart-period:hover {
      background: var(--bg-800);
      color: var(--text-primary);
    }

    .chart-period.active {
      background: var(--gradient-red);
      color: white;
      box-shadow: 0 0 10px var(--glow-red);
    }

    /* View Profile Modal */
    .profile-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2200;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: 0.2s;
    }

    .profile-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .profile-modal {
      width: 900px;
      max-width: 95%;
      background: var(--admin-bg);
      border-radius: 12px;
      border: 1px solid #333;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .profile-header {
      background: var(--admin-card);
      padding: 32px;
      display: flex;
      align-items: center;
      gap: 24px;
      border-bottom: 1px solid #333;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      border: 2px solid var(--admin-accent);
      color: #fff;
    }

    .profile-info h2 {
      margin: 0 0 4px 0;
      color: #fff;
      font-size: 24px;
    }

    .profile-info p {
      margin: 0;
      color: #888;
      font-size: 14px;
    }

    .profile-body {
      padding: 32px;
      background: #000;
      overflow-y: auto;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-bottom: 32px;
    }

    .info-card {
      background: var(--admin-card);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #333;
    }

    .info-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 8px;
      display: block;
    }

    .info-value {
      font-size: 16px;
      color: #fff;
      font-weight: 500;
      display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-sidebar {
        position: fixed;
        left: -260px;
        height: 100%;
        transition: 0.3s;
        z-index: 2100;
      }

      .admin-sidebar.open {
        left: 0;
      }

      .profile-grid {
        grid-template-columns: 1fr;
      }
    }

    .search-wrapper {
      position: relative;
      max-width: 320px;
      width: 100%;
      margin: 0 16px;
      margin-left: auto;
    }

    .search-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.08) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      color: #fff !important;
      padding: 10px 16px 10px 36px !important;
      border-radius: 99px !important;
      transition: all 0.2s;
      font-size: 14px;
    }

    .search-input:focus {
      background: rgba(255, 255, 255, 0.12) !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
      outline: none !important;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.5;
      pointer-events: none;
    }

    .search-dropdown {
      position: absolute;
      top: 110%;
      left: 0;
      right: 0;
      background: #1e1e1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      max-height: 480px;
      overflow-y: auto;
      display: none;
      scrollbar-width: thin;
    }

    .search-dropdown.active {
      display: block;
      animation: slideIn 0.1s;
    }

    .search-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: background 0.1s;
    }

    .search-item:last-child {
      border-bottom: none;
    }

    .search-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .search-item img {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      object-fit: cover;
      background: #333;
      flex-shrink: 0;
    }

    .search-meta {
      flex: 1;
      min-width: 0;
    }

    .search-title {
      font-weight: 500;
      color: #fff;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .search-subtitle {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .search-tag {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.6);
      flex-shrink: 0;
    }

    /* Mobile Responsive Search */
    @media (max-width: 600px) {
      .search-wrapper {
        order: 3;
        max-width: 100%;
        margin: 12px 0 0 0;
        width: 100%;
        flex-basis: 100%;
      }

      .topbar {
        flex-wrap: wrap;
      }
    }

    /* ================= PROGRESS & SIDEBAR ================= */
    .lesson-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 32px;
      margin-top: 24px;
    }

    .lesson-main {
      width: 100%;
    }

    .lesson-sidebar {
      background: var(--brand-card);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 16px;
      height: fit-content;
      max-height: 80vh;
      overflow-y: auto;
    }

    .lesson-sidebar h3 {
      font-size: 16px;
      color: var(--text-light);
      margin-top: 0;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-light);
      padding-bottom: 12px;
    }

    .sidebar-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.2s ease;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .sidebar-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .sidebar-item.active {
      background: rgba(220, 38, 38, 0.1);
      border-left: 3px solid var(--brand-red);
    }

    .sidebar-item-status {
      font-size: 14px;
      width: 20px;
      text-align: center;
    }

    .sidebar-item-title {
      font-size: 14px;
      color: var(--text-muted);
    }

    .sidebar-item.active .sidebar-item-title {
      color: var(--brand-red);
      font-weight: 700;
    }

    .btn-complete {
      width: 100%;
      background: var(--brand-red);
      color: white;
      padding: 16px;
      font-size: 16px;
      font-weight: 800;
      border: none;
      border-radius: 12px;
      margin-top: 24px;
      cursor: pointer;
      box-shadow: var(--glow-red);
      text-transform: uppercase;
      transition: all 0.3s ease;
    }

    .btn-complete:hover {
      transform: scale(1.02);
      box-shadow: 0 0 20px rgba(220, 38, 38, 0.6);
    }

    @media (max-width: 900px) {
      .lesson-layout {
        grid-template-columns: 1fr;
      }
    }

    /* NEW COURSE CARD ACTIONS */
    .course-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex !important;
      gap: 6px;
      z-index: 20;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.2s ease-out;
    }

    .card:hover .course-actions {
      opacity: 1;
      transform: translateY(0);
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.15);
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: white;
      color: black;
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }

    .btn-icon i,
    .btn-icon svg {
      width: 14px;
      height: 14px;
      stroke-width: 2px;
    }

    /* Specific Colors on Hover */
    .btn-report:hover {
      color: #3b82f6;
      border-color: #3b82f6;
    }

    .btn-add-student:hover {
      color: #10b981;
      border-color: #10b981;
    }

    .btn-refresh:hover {
      color: #f59e0b;
      border-color: #f59e0b;
    }

    .btn-edit:hover {
      color: #8b5cf6;
      border-color: #8b5cf6;
    }

    .btn-delete:hover {
      color: #ef4444;
      border-color: #ef4444;
    }

    /* LESSON DETAIL BTN */
    .btn-lesson-detail-mini {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #a1a1aa;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-lesson-detail-mini:hover {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }

    /* MODAL LEVEL 2 (Detail) */
    .modal-overlay-2 {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      /* Highest priority */
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s;
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <div id="modalAddCourse" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">TH√äM KH√ìA H·ªåC TH·ª¶ C√îNG</h2>
        <button class="modal-close" onclick="closeModalAddCourse()">√ó</button>
      </div>
      <div id="modalMsg"></div>
      <form id="formAddCourse" onsubmit="return false;">
        <div class="form-group">
          <label class="form-label">T√™n kh√≥a h·ªçc *</label>
          <input type="text" class="form-input" id="courseName" required>
        </div>
        <div class="form-group">
          <label class="form-label">M√¥ t·∫£ kh√≥a h·ªçc</label>
          <textarea class="form-input" id="courseDesc" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Thumbnail</label>
          <input type="text" class="form-input" id="courseThumbnail" placeholder="Link Drive ho·∫∑c URL">
          <div class="file-input-group">
            <button type="button" class="btn-pick-file" onclick="pickThumbnail()">üìÅ Ch·ªçn t·ª´ Drive</button>
          </div>
        </div>
        <hr style="border: 1px solid var(--border-light); margin: 32px 0;">
        <h3>Danh s√°ch b√†i h·ªçc</h3>
        <div id="lessonsContainer"></div>
        <button type="button" class="btn btn-add-lesson" onclick="addLessonField()"
          style="width: 100%; margin-top: 24px;">+ Th√™m b√†i h·ªçc</button>
        <button type="submit" class="form-btn" style="margin-top: 32px;">T·∫°o kh√≥a h·ªçc</button>
      </form>
    </div>
  </div>

  <div id="modalEditCourse" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">‚úèÔ∏è CH·ªàNH S·ª¨A KH√ìA H·ªåC</h2>
        <button class="modal-close" onclick="closeModalEditCourse()">√ó</button>
      </div>
      <div id="modalEditMsg"></div>
      <form id="formEditCourse" onsubmit="return false;">
        <input type="hidden" id="editOldCourseName">
        <div class="form-group">
          <label class="form-label">T√™n kh√≥a h·ªçc *</label>
          <input type="text" class="form-input" id="editCourseName" required>
        </div>
        <div class="form-group">
          <label class="form-label">M√¥ t·∫£ kh√≥a h·ªçc</label>
          <textarea class="form-input" id="editCourseDesc" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Thumbnail</label>
          <input type="text" class="form-input" id="editCourseThumbnail" placeholder="Link Drive ho·∫∑c URL">
          <div class="file-input-group">
            <button type="button" class="btn-pick-file" onclick="pickThumbnail()">üìÅ Ch·ªçn t·ª´ Drive</button>
          </div>
        </div>
        <hr style="border: 1px solid var(--border-light); margin: 32px 0;">
        <h3>Danh s√°ch b√†i h·ªçc</h3>
        <div id="editLessonsContainer"></div>
        <button type="button" class="btn btn-add-lesson" onclick="addEditLessonField()"
          style="width: 100%; margin-top: 24px;">+ Th√™m b√†i h·ªçc</button>
        <button type="submit" class="form-btn" style="margin-top: 32px;">üíæ L∆∞u thay ƒë·ªïi</button>
      </form>
    </div>
  </div>

  <div id="modalQuickAdd" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">‚ö° TH√äM NHANH KH√ìA H·ªåC</h2>
        <button class="modal-close" onclick="closeModalQuickAdd()">√ó</button>
      </div>
      <div class="info-box">
        <div class="info-box-title">üìÅ C·∫•u tr√∫c folder y√™u c·∫ßu:</div>
        <div class="info-box-content">
          <code>Kh√≥a H·ªçc D/
‚îú‚îÄ‚îÄ thumbnail.jpg
‚îú‚îÄ‚îÄ B√†i 1: Gi·ªõi thi·ªáu/
‚îÇ   ‚îú‚îÄ‚îÄ video.mp4
‚îÇ   ‚îî‚îÄ‚îÄ material.pdf
‚îî‚îÄ‚îÄ B√†i 2: N·ªôi dung/
    ‚îú‚îÄ‚îÄ lesson.mp4
    ‚îî‚îÄ‚îÄ slides.pdf</code>
        </div>
      </div>
      <div id="quickAddMsg"></div>
      <form id="formQuickAdd" onsubmit="return false;">
        <div class="form-group">
          <label class="form-label">Link Google Drive Folder *</label>
          <input type="text" class="form-input" id="quickFolderUrl"
            placeholder="https://drive.google.com/drive/folders/..." required>
          <div style="color: var(--text-muted); font-size: 12px; margin-top: 8px; font-weight: 500;">
            üí° ƒê·∫£m b·∫£o folder ƒë√£ ƒë∆∞·ª£c share "Anyone with the link can view"
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">M√¥ t·∫£ kh√≥a h·ªçc (t√πy ch·ªçn)</label>
          <textarea class="form-input" id="quickCourseDesc" rows="3" placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ kh√≥a h·ªçc..."></textarea>
        </div>
        <button type="submit" class="form-btn">‚ö° Th√™m nhanh</button>
      </form>
    </div>
  </div>

  <div id="modalAddStudent" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">üë• TH√äM H·ªåC VI√äN</h2>
        <button class="modal-close" onclick="closeModalAddStudent()">√ó</button>
      </div>
      <div id="addStudentMsg"></div>
      <form id="formAddStudent" onsubmit="return false;">
        <input type="hidden" id="addStudentCourseName">
        <div class="info-box">
          <div class="info-box-title">Kh√≥a h·ªçc: <span id="lblCourseName" style="color:var(--text-light)"></span></div>
        </div>
        <div class="form-group">
          <label class="form-label">Email h·ªçc vi√™n (M·ªói d√≤ng 1 email ho·∫∑c c√°ch nhau d·∫•u ph·∫©y)</label>
          <textarea class="form-input" id="studentEmails" rows="5" required
            placeholder="nguyenva@gmail.com, tranvb@gmail.com..."></textarea>
        </div>
        <button type="submit" class="form-btn">TH√äM H·ªåC VI√äN</button>
      </form>
    </div>
  </div>

  <!-- MODAL FORGOT PASSWORD (OTP) -->
  <div id="modalForgotPassword" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">üîê QU√äN M·∫¨T KH·∫®U</h2>
        <button class="modal-close" onclick="closeModalForgotPassword()">√ó</button>
      </div>
      <div id="forgotMsg"></div>

      <!-- STEP 1: G·ª≠i OTP -->
      <div id="forgotStep1">
        <div class="form-group">
          <label class="form-label">Email c·ªßa b·∫°n</label>
          <input type="email" class="form-input" id="resetEmail" required placeholder="Nh·∫≠p email ƒë√£ ƒëƒÉng k√Ω">
        </div>
        <button class="form-btn" onclick="handleSendOTP()">G·ª≠i m√£ OTP</button>
      </div>

      <!-- STEP 2: X√°c nh·∫≠n OTP & ƒê·ªïi Pass -->
      <div id="forgotStep2" style="display:none;">
        <div class="form-group">
          <label class="form-label">M√£ OTP (ƒë√£ g·ª≠i v·ªÅ email)</label>
          <input type="text" class="form-input" id="resetOTP" required placeholder="6 s·ªë" maxlength="6">
        </div>
        <div class="form-group">
          <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
          <input type="password" class="form-input" id="resetNewPass" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi"
            minlength="6">
        </div>
        <button class="form-btn" onclick="handleVerifyReset()">X√°c nh·∫≠n ƒë·ªïi m·∫≠t kh·∫©u</button>
        <div style="text-align:center;margin-top:12px;">
          <a onclick="backToStep1()" style="color:#aaa;font-size:13px;cursor:pointer;">‚Üê G·ª≠i l·∫°i OTP</a>
        </div>
      </div>

    </div>
  </div>
  <script>
    // ========== C·∫§U H√åNH API - THAY ƒê·ªîI URL N√ÄY ==========
    const API_URL = 'https://script.google.com/macros/s/AKfycbyjqXySQ-hPctPGzbAyhuRxQEK-B3f68GFhDu7Chd6iaocn1rcW_yzVbjfsD4qCUvEJnw/exec';

    // H√†m g·ªçi API
    // ‚úÖ ƒê·ªîI SANG FormData
    // ==========================================
    // ADMIN DASHBOARD LOGIC
    // ==========================================

    // 1. MAIN RENDER
    function renderAdminDashboard(initialTab = 'overview') {
      state.view = 'admin_dashboard';

      // Update URL to persist state
      setUrl({ view: 'dashboard', tab: initialTab });

      app.innerHTML = `
        <div class="admin-layout">
           <!-- SIDEBAR -->
           <div class="admin-sidebar" id="adminSidebar" style="background:var(--bg-900);border-right:1px solid var(--border)">
              <div style="padding:24px;border-bottom:1px solid var(--border)">
                 <div class="logo" style="font-size:18px;font-weight:900;color:var(--brand-red);letter-spacing:-0.5px">
                    LMS <span style="color:var(--text-primary);font-weight:500">ADMIN</span>
                 </div>
              </div>
              <div class="admin-menu" style="padding:16px">
                 <div class="menu-item ${initialTab === 'overview' ? 'active' : ''}" onclick="switchAdminTab('overview', this)" style="margin-bottom:8px">
                    <span class="menu-icon"><i data-lucide="pie-chart"></i></span> Overview
                 </div>
                 <div class="menu-item ${initialTab === 'users' ? 'active' : ''}" onclick="switchAdminTab('users', this)" style="margin-bottom:8px">
                    <span class="menu-icon"><i data-lucide="users"></i></span> Users
                 </div>
                 <div class="menu-item" onclick="renderHome()" style="margin-top:24px;color:var(--text-muted)">
                    <span class="menu-icon"><i data-lucide="home"></i></span> Back Home
                 </div>
              </div>
              <div style="margin-top:auto;padding:24px;border-top:1px solid var(--border)">
                 <div style="display:flex;align-items:center;gap:12px">
                    <div style="width:40px;height:40px;border-radius:50%;background:var(--bg-800);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700">
                       ${state.user.name.charAt(0).toUpperCase()}
                    </div>
                    <div style="flex:1">
                       <div style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:2px">${escapeHtml(state.user.name)}</div>
                       <div style="font-size:11px;color:var(--text-muted)">Admin</div>
                    </div>
                 </div>
              </div>
           </div>
           
           <!-- MAIN CONTENT -->
           <div class="admin-main">
              <div class="admin-header">
                 <div style="font-size:14px;color:#888" id="adminBreadcrumb">Dashboard > ${initialTab === 'overview' ? 'Overview' : 'Users'}</div>
                 <div class="btn-icon" onclick="toggleAdminSidebar()" style="display:none">‚ò∞</div>
              </div>
              
              <div class="admin-content" id="adminContent">
                 <!-- CONTENT LOADED HERE -->
                 <div style="text-align:center;padding:40px;color:#666">Loading dashboard...</div>
              </div>
           </div>
           
           <!-- MODAL PROFILE -->
           <div class="profile-modal-overlay" id="modalUserProfile" onclick="if(event.target===this) closeUserProfile()">
              <div class="profile-modal">
                 <div id="userProfileContent"></div>
              </div>
           </div>
        </div>
      `;

      // Initialize Lucide icons for sidebar
      if (window.lucide) lucide.createIcons();

      // Load Initial Tab
      if (initialTab === 'users') {
        loadAdminUsers();
      } else {
        loadAdminOverview();
      }
    }

    function switchAdminTab(tab, el) {
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
      if (el) el.classList.add('active');

      // Update URL
      setUrl({ view: 'dashboard', tab: tab });

      if (tab === 'overview') {
        document.getElementById('adminBreadcrumb').innerText = 'Dashboard > Overview';
        loadAdminOverview();
      } else if (tab === 'users') {
        document.getElementById('adminBreadcrumb').innerText = 'Dashboard > Users';
        loadAdminUsers();
      }
    }

    // 2. OVERVIEW TAB
    const DASHBOARD_CACHE_KEY = 'lms_dashboard_cache';
    const DASHBOARD_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in ms

    async function loadAdminOverview(forceRefresh = false) {
      const content = document.getElementById('adminContent');

      // Check localStorage cache first (instant!)
      if (!forceRefresh) {
        const cached = localStorage.getItem(DASHBOARD_CACHE_KEY);
        if (cached) {
          try {
            const parsed = JSON.parse(cached);
            if (Date.now() < parsed.expiry) {
              console.log('‚ö° Dashboard from localStorage cache!');
              renderDashboardContent(content, parsed.data, true);
              loadChartDataAsync(); // Still lazy load chart
              return;
            }
          } catch (e) { /* cache invalid, continue */ }
        }
      }

      content.innerHTML = '<div style="text-align:center;margin-top:40px;color:#888">‚è≥ Loading stats...</div>';

      try {
        // Load stats from API
        const res = await callAPI('getAdminStats', { forceRefresh: forceRefresh });
        if (!res.success) throw new Error(res.message);

        // Save to localStorage
        localStorage.setItem(DASHBOARD_CACHE_KEY, JSON.stringify({
          data: res,
          expiry: Date.now() + DASHBOARD_CACHE_DURATION
        }));

        renderDashboardContent(content, res, false);
        loadChartDataAsync();

      } catch (e) {
        content.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
      }
    }

    // Render Dashboard UI (reusable for cache and fresh data)
    function renderDashboardContent(content, res, fromCache) {
      const s = res.stats;
      const recent = res.recentUsers || [];

      content.innerHTML = `
         <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:32px">
            <div>
               <h2 style="font-size:24px; font-weight:700; margin:0 0 8px 0; color:var(--text-primary)">Overview</h2>
               <p style="color:var(--text-muted); font-size:13px; margin:0">Track your platform's performance and user activity</p>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
               ${fromCache
          ? `<div style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.2);border-radius:20px">
                       <i data-lucide="zap" style="width:14px;color:#f97316;fill:currentColor"></i>
                       <span style="font-size:11px;font-weight:700;color:#f97316;text-transform:uppercase;letter-spacing:0.5px">Instant</span>
                     </div>`
          : `<div style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:20px">
                       <i data-lucide="check-circle-2" style="width:14px;color:#22c55e"></i>
                       <span style="font-size:11px;font-weight:700;color:#22c55e;text-transform:uppercase;letter-spacing:0.5px">Fresh</span>
                     </div>`}
               <button class="btn btn-red" onclick="loadAdminOverview(true)" style="padding:10px 20px;border-radius:10px;font-weight:700">
                  <i data-lucide="refresh-cw" style="width:14px;margin-right:6px"></i> Refresh
               </button>
            </div>
         </div>
         
         <!-- STATS GRID - ROW 1 -->
         <div class="stats-grid">
            <!-- Card 1: Total Users -->
            <div class="stat-card">
               <div class="stat-icon purple"><i data-lucide="users"></i></div>
               <div class="stat-label">Total Users</div>
               <div class="stat-value">${s.totalUsers}</div>
               <div class="stat-trend"><i data-lucide="user-check" style="width:14px"></i> ${s.approvedUsers || 0} Approved</div>
               <div class="stat-progress">
                  <div class="stat-progress-fill purple" style="width:${Math.round((s.approvedUsers / s.totalUsers) * 100)}%"></div>
               </div>
               <i data-lucide="users" class="stat-icon-bg"></i>
            </div>
            
            <!-- Card 2: Pending Approval -->
            <div class="stat-card">
               <div class="stat-icon yellow"><i data-lucide="clock"></i></div>
               <div class="stat-label">Pending Approval</div>
               <div class="stat-value" style="color:#eab308">${s.pendingUsers || 0}</div>
               <div class="stat-trend"><i data-lucide="hourglass" style="width:14px"></i> Waiting for review</div>
               <div class="stat-progress">
                  <div class="stat-progress-fill yellow" style="width:${s.pendingUsers > 0 ? Math.min((s.pendingUsers / s.totalUsers) * 100, 100) : 0}%"></div>
               </div>
               <i data-lucide="clock" class="stat-icon-bg"></i>
            </div>
            
            <!-- Card 3: Active Learners -->
            <div class="stat-card">
               <div class="stat-icon green"><i data-lucide="activity"></i></div>
               <div class="stat-label">Active Learners</div>
               <div class="stat-value" style="color:#22c55e">${s.activeLearners || 0}</div>
               <div class="stat-trend">
                  <span style="width:8px;height:8px;background:#22c55e;border-radius:50%;display:inline-block;animation:pulse 2s infinite"></span>
                  Currently studying
               </div>
               <div class="stat-progress">
                  <div class="stat-progress-fill green" style="width:${s.activeLearners > 0 ? Math.round((s.activeLearners / s.totalUsers) * 100) : 0}%"></div>
               </div>
               <i data-lucide="target" class="stat-icon-bg"></i>
            </div>
            
            <!-- Card 4: Total Courses -->
            <div class="stat-card">
               <div class="stat-icon blue"><i data-lucide="book"></i></div>
               <div class="stat-label">Total Courses</div>
               <div class="stat-value">${s.totalCourses}</div>
               <div class="stat-trend"><i data-lucide="bookmark" style="width:14px"></i> ${s.totalLessons || 0} Lessons</div>
               <div class="stat-progress">
                  <div class="stat-progress-fill blue" style="width:100%"></div>
               </div>
               <i data-lucide="layers" class="stat-icon-bg"></i>
            </div>
         </div>
         
         <!-- STATS GRID - ROW 2 -->
         <div class="stats-grid" style="margin-top:16px">
            <!-- Completed Lessons (Compact with circular progress simulation) -->
            <div class="stat-card" style="background:var(--bg-800)">
               <div class="stat-icon red"><i data-lucide="trophy"></i></div>
               <div class="stat-label">Completed Lessons</div>
               <div class="stat-value" style="color:var(--brand-red)">${s.completedLessons}</div>
               <div class="stat-trend"><i data-lucide="check-circle" style="width:14px"></i> Learning Progress</div>
               <div class="stat-progress">
                  <div class="stat-progress-fill red" style="width:0%"></div>
               </div>
               <i data-lucide="award" class="stat-icon-bg"></i>
            </div>
            
            <!-- User Growth Chart (Spanning 3 columns) -->
            <div class="stat-card" style="grid-column: span 3; background:var(--bg-800); border-color:var(--border)">
               <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                  <div style="display:flex; align-items:center; gap:12px">
                     <div style="width:4px; height:24px; background:var(--brand-red); border-radius:2px"></div>
                     <div class="stat-label" style="margin:0; font-size:14px; letter-spacing:1px">USER GROWTH</div>
                  </div>
                  <div style="display:flex;gap:8px">
                     <button class="btn-sm chart-period active" data-period="7" onclick="updateChartPeriod(7, this)">7 Days</button>
                     <button class="btn-sm chart-period" data-period="30" onclick="updateChartPeriod(30, this)">30 Days</button>
                     <button class="btn-sm chart-period" data-period="90" onclick="updateChartPeriod(90, this)">90 Days</button>
                  </div>
               </div>
               <div style="height:200px;position:relative" id="chartContainer">
                  <div style="text-align:center;padding:60px;color:#666">üìä Loading chart...</div>
               </div>
            </div>
         </div>
         
         <!-- RECENT USERS -->
         <div class="table-card" style="margin-top:24px">
            <div class="table-header" style="margin-bottom:24px">
               <div class="table-title" style="font-size:14px; font-weight:700; text-transform:uppercase; letter-spacing:1px">Recently Joined Users</div>
               <button class="btn-sm" onclick="switchAdminTab('users', document.querySelectorAll('.menu-item')[1])" style="display:flex;align-items:center;gap:8px;background:var(--bg-800);border-color:var(--border)">
                  View All <i data-lucide="arrow-right" style="width:14px"></i>
               </button>
            </div>
            <table class="data-table" style="width:100%">
               <thead>
                  <tr style="border-bottom:1px solid var(--border)">
                     <th style="text-align:left;padding:12px 16px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:700">Name</th>
                     <th style="text-align:left;padding:12px 16px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:700">Email</th>
                     <th style="text-align:left;padding:12px 16px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:700">Status</th>
                     <th style="text-align:left;padding:12px 16px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:700">Joined</th>
                     <th style="text-align:right;padding:12px 16px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:700">Action</th>
                  </tr>
               </thead>
               <tbody>
                  ${recent.map(u => `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background=''">
                       <td style="padding:16px">
                          <div style="display:flex;align-items:center;gap:12px">
                             <div style="width:40px;height:40px;border-radius:50%;background:var(--bg-700);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--text-primary)">
                                ${String(u.name || '').charAt(0).toUpperCase()}
                             </div>
                             <span style="font-weight:600;color:var(--text-primary);transition:color 0.2s" onmouseover="this.style.color='var(--brand-red)'" onmouseout="this.style.color='var(--text-primary)'">
                                ${escapeHtml(u.name)}
                             </span>
                          </div>
                       </td>
                       <td style="padding:16px;color:var(--text-secondary);font-size:13px">${escapeHtml(u.email)}</td>
                       <td style="padding:16px">
                          <span class="status-badge ${u.status === 'Approve' ? 'status-active' : 'status-inactive'}" style="padding:4px 12px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;
                             ${u.status === 'Approve'
              ? 'background:rgba(34,197,94,0.1);color:#22c55e;border:1px solid rgba(34,197,94,0.2)'
              : 'background:rgba(234,179,8,0.1);color:#eab308;border:1px solid rgba(234,179,8,0.2)'}">
                             ${u.status === 'Approve' ? 'Approved' : 'Pending'}
                          </span>
                       </td>
                       <td style="padding:16px;color:var(--text-muted);font-size:12px;font-family:monospace">${escapeHtml(u.joinedDate)}</td>
                       <td style="padding:16px;text-align:right">
                          <button class="btn-sm" onclick="viewUserProfile('${u.email}')" style="padding:8px 12px;background:var(--bg-800);border-color:var(--border)">
                             <i data-lucide="eye" style="width:14px"></i>
                          </button>
                       </td>
                    </tr>
                  `).join('')}
               </tbody>
            </table>
         </div>
       `;

      // Initialize Lucide icons
      if (window.lucide) lucide.createIcons();
    }

    // Lazy load chart data with localStorage cache
    const CHART_CACHE_KEY = 'lms_chart_cache';
    async function loadChartDataAsync() {
      try {
        // Check localStorage cache first
        const cached = localStorage.getItem(CHART_CACHE_KEY);
        if (cached) {
          const parsed = JSON.parse(cached);
          if (Date.now() < parsed.expiry) {
            renderChart(parsed.data);
            return;
          }
        }

        const chartRes = await callAPI('getAdminChartData', {});
        if (chartRes.success) {
          localStorage.setItem(CHART_CACHE_KEY, JSON.stringify({
            data: chartRes.userGrowth || [],
            expiry: Date.now() + DASHBOARD_CACHE_DURATION
          }));
          renderChart(chartRes.userGrowth || []);
        }
      } catch (e) {
        console.error('Chart load error:', e);
      }
    }

    function renderChart(data) {
      const container = document.getElementById('chartContainer');
      if (container) {
        container.innerHTML = '<canvas id="userGrowthChart"></canvas>';
        window.userGrowthData = data;
        initUserGrowthChart(data, 7);
      }
    }

    // Chart Helper Functions
    let userGrowthChartInstance = null;

    function initUserGrowthChart(data, days) {
      const ctx = document.getElementById('userGrowthChart');
      if (!ctx) return;

      // Filter data to last N days
      const now = new Date();
      const cutoff = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
      const filtered = data.filter(d => new Date(d.date) >= cutoff);

      // Generate labels for the period (fill missing dates with 0)
      const labels = [];
      const counts = [];
      const dataMap = {};
      filtered.forEach(d => dataMap[d.date] = d.count);

      for (let i = days - 1; i >= 0; i--) {
        const d = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
        const key = d.toISOString().split('T')[0];
        labels.push(d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
        counts.push(dataMap[key] || 0);
      }

      // Destroy existing chart
      if (userGrowthChartInstance) {
        userGrowthChartInstance.destroy();
      }

      userGrowthChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'New Users',
            data: counts,
            borderColor: '#e50914',
            backgroundColor: 'rgba(229, 9, 20, 0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointBackgroundColor: '#e50914'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888', font: { size: 10 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888', stepSize: 1 }
            }
          }
        }
      });
    }

    function updateChartPeriod(days, btn) {
      document.querySelectorAll('.chart-period').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      initUserGrowthChart(window.userGrowthData || [], days);
    }

    // 3. USERS TAB
    const USERS_CACHE_KEY = 'lms_users_cache';

    async function loadAdminUsers(forceRefresh = false) {
      const content = document.getElementById('adminContent');

      // Check localStorage cache first
      if (!forceRefresh) {
        const cached = localStorage.getItem(USERS_CACHE_KEY);
        if (cached) {
          try {
            const parsed = JSON.parse(cached);
            if (Date.now() < parsed.expiry) {
              console.log('‚ö° Users from localStorage cache!');
              renderUsersContent(content, parsed.data, true);
              return;
            }
          } catch (e) { /* cache invalid */ }
        }
      }

      content.innerHTML = '<div style="text-align:center;margin-top:40px;color:#888">‚è≥ Loading users...</div>';

      try {
        const res = await callAPI('getAllStudents', {});
        if (!res.success) throw new Error(res.message);

        // Save to cache
        localStorage.setItem(USERS_CACHE_KEY, JSON.stringify({
          data: res,
          expiry: Date.now() + DASHBOARD_CACHE_DURATION
        }));

        renderUsersContent(content, res, false);

      } catch (e) {
        content.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
      }
    }

    function renderUsersContent(content, res, fromCache) {
      const users = res.students || [];

      content.innerHTML = `
         <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
            <div class="admin-title" style="margin:0">User Management</div>
            <div style="display:flex;align-items:center;gap:12px">
               ${fromCache ? '<span style="color:#888;font-size:12px">‚ö° Instant</span>' : '<span style="color:#4ade80;font-size:12px">‚ú® Fresh</span>'}
               <input type="text" class="search-input" style="width:200px;margin:0" placeholder="Search user..." oninput="filterUserTable(this.value)">
               <button class="btn-sm btn-red" onclick="loadAdminUsers(true)">üîÑ Refresh</button>
            </div>
         </div>
         
         <div class="table-card">
            <table class="data-table" id="userTable">
               <thead>
                  <tr>
                     <th>Name</th>
                     <th>Email</th>
                     <th>Phone</th>
                     <th>Role</th>
                     <th>Status</th>
                     <th>Actions</th>
                  </tr>
               </thead>
               <tbody>
                  ${users.map(u => `
                    <tr class="user-row">
                       <td style="display:flex;align-items:center;gap:12px">
                          <div class="profile-avatar" style="width:32px;height:32px;font-size:12px;border-width:1px">${String(u.name || '').charAt(0)}</div>
                          <span class="u-name">${escapeHtml(u.name)}</span>
                       </td>
                       <td class="u-email">${escapeHtml(u.email)}</td>
                       <td class="u-phone">${escapeHtml(u.phone)}</td>
                       <td>${escapeHtml(u.role)}</td>
                       <td>
                          <span class="status-badge ${u.status === 'Locked' ? 'status-inactive' : 'status-active'}">${u.status}</span>
                       </td>
                       <td style="display:flex;gap:8px">
                          <button class="btn-sm" onclick="viewUserProfile('${u.email}')">üëÅÔ∏è View</button>
                          <button class="btn-sm" onclick="toggleLockUser('${u.email}', '${u.status}')" style="color:${u.status === 'Locked' ? '#4caf50' : '#f44336'}">
                             ${u.status === 'Locked' ? 'üîì Unlock' : 'üîí Lock'}
                          </button>
                       </td>
                    </tr>
                  `).join('')}
               </tbody>
            </table>
         </div>
       `;
    }

    // Filter Helper
    function filterUserTable(keyword) {
      const rows = document.querySelectorAll('.user-row');
      keyword = keyword.toLowerCase();
      rows.forEach(r => {
        const text = r.innerText.toLowerCase();
        r.style.display = text.includes(keyword) ? '' : 'none';
      });
    }

    // 4. VIEW PROFILE & ACTIONS
    async function viewUserProfile(email) {
      const modal = document.getElementById('modalUserProfile');
      const body = document.getElementById('userProfileContent');
      modal.classList.add('active');
      body.innerHTML = '<div style="padding:40px;text-align:center;color:#fff">Loading details...</div>';

      try {
        const res = await callAPI('getStudentDetails', { email });
        if (!res.success) throw new Error(res.message);

        const u = res.user;
        const statusClass = 'status-active'; // Default
        const statusText = 'Verified';

        body.innerHTML = `
             <div class="profile-header">
                <div class="profile-avatar">${u.name.charAt(0)}</div>
                <div class="profile-info">
                   <h2>${escapeHtml(u.name)}</h2>
                   <p>@${u.email.split('@')[0]}</p>
                </div>
                <span class="status-badge ${statusClass}" style="margin-left:auto">${statusText}</span>
             </div>
             
             <div class="profile-body">
                <div class="profile-grid">
                   <div class="info-card">
                      <span class="info-label">Verification Status</span>
                      <span class="info-value" style="color:#4caf50">Verified</span>
                   </div>
                   <div class="info-card">
                      <span class="info-label">Phone</span>
                      <span class="info-value">${escapeHtml(u.phone)}</span>
                   </div>
                   <div class="info-card">
                      <span class="info-label">Country</span>
                      <span class="info-value">Vietnam üáªüá≥</span>
                   </div>
                </div>
                
                <h3 style="color:#fff;margin-bottom:16px;font-size:16px">Account Details</h3>
                <div class="profile-grid">
                   <div class="info-card">
                       <span class="info-label">Email</span>
                       <span class="info-value">${escapeHtml(u.email)}</span>
                   </div>
                   <div class="info-card">
                       <span class="info-label">Enrolled Courses</span>
                       <span class="info-value">${u.coursesCount} Courses</span>
                   </div>
                   <div class="info-card">
                       <span class="info-label">Completed Lessons</span>
                       <span class="info-value">${u.completedLessons} Lessons</span>
                   </div>
                </div>
                
                <h3 style="color:#fff;margin-bottom:16px;font-size:16px">Actions</h3>
                <div style="display:flex;gap:12px">
                   <button class="btn-sm" style="padding:10px 20px;background:#333" onclick="adminResetPass('${u.email}')">üîë Reset Password</button>
                   <button class="btn-sm" style="padding:10px 20px;background:#333;color:#f44336" onclick="closeUserProfile()">Close</button>
                </div>
             </div>
          `;
      } catch (e) {
        body.innerHTML = `<div style="padding:20px;color:red">Error: ${e.message}</div>`;
      }
    }

    function closeUserProfile() {
      document.getElementById('modalUserProfile').classList.remove('active');
    }

    async function toggleLockUser(email, currentStatus) {
      const newStatus = currentStatus === 'Locked' ? 'Active' : 'Locked';
      if (!confirm(`Are you sure you want to ${newStatus} this user?`)) return;

      showToast('Updating status...', 'info');
      const res = await callAPI('updateStudentStatus', { email, status: newStatus });
      if (res.success) {
        showToast('Updated successfully!', 'success');
        loadAdminUsers(); // Reload table
      } else {
        showToast(res.message, 'error');
      }
    }

    async function adminResetPass(email) {
      if (!confirm(`Reset password for ${email} to default '123456'?`)) return;
      showToast('Resetting password...', 'info');
      const res = await callAPI('adminResetStudentPass', { email });
      if (res.success) {
        showToast('Password reset successfully!', 'success');
      } else {
        showToast(res.message, 'error');
      }
    }

    // 5. PERSONAL PROFILE
    function openPersonalProfile() {
      const modal = document.getElementById('modalUserProfile');
      const body = document.getElementById('userProfileContent');
      modal.classList.add('active');

      const u = state.user;
      // Assuming u.phone is available. If not, might need to fetchProfile first or rely on login data.
      const phone = u.phone || '';

      body.innerHTML = `
          <div class="profile-header">
             <div class="profile-avatar">${u.name.charAt(0)}</div>
             <div class="profile-info">
                <h2>${escapeHtml(u.name)}</h2>
                <p>@${u.email.split('@')[0]}</p>
             </div>
             <span class="status-badge status-active" style="margin-left:auto">Personal Mode</span>
          </div>
          
          <div class="profile-body">
             <form id="formProfile" onsubmit="handleUpdateProfile(event)">
                <div class="profile-grid">
                   <div class="info-card">
                      <span class="info-label">Email (Read-only)</span>
                      <input type="text" class="form-input" style="background:#333;color:#888" value="${escapeHtml(u.email)}" disabled>
                   </div>
                   <div class="info-card">
                      <span class="info-label">Full Name</span>
                      <input type="text" class="form-input" id="pName" style="background:#111;color:#fff;border:1px solid #333" value="${escapeHtml(u.name)}" required>
                   </div>
                   <div class="info-card">
                      <span class="info-label">Phone Number</span>
                      <input type="tel" class="form-input" id="pPhone" style="background:#111;color:#fff;border:1px solid #333" value="${escapeHtml(phone)}">
                   </div>
                </div>
                
                <h3 style="color:#fff;margin-bottom:16px;font-size:16px">Change Password (Optional)</h3>
                <div class="profile-grid">
                   <div class="info-card">
                       <span class="info-label">Old Password</span>
                       <input type="password" class="form-input" id="pOldPass" style="background:#111;color:#fff;border:1px solid #333" placeholder="Required if changing pass">
                   </div>
                   <div class="info-card">
                       <span class="info-label">New Password</span>
                       <input type="password" class="form-input" id="pNewPass" style="background:#111;color:#fff;border:1px solid #333" placeholder="Leave empty to keep current">
                   </div>
                </div>
                
                <h3 style="color:#fff;margin-bottom:16px;font-size:16px">Actions</h3>
                <div style="display:flex;gap:12px">
                   <button type="submit" class="btn-sm" style="padding:10px 24px;background:var(--admin-accent);font-size:14px">üíæ Save Changes</button>
                   <button type="button" class="btn-sm" style="padding:10px 24px;background:#333;font-size:14px" onclick="closeUserProfile()">Cancel</button>
                </div>
             </form>
          </div>
       `;
    }

    async function handleUpdateProfile(e) {
      e.preventDefault();

      const name = document.getElementById('pName').value.trim();
      const phone = document.getElementById('pPhone').value.trim();
      const oldPass = document.getElementById('pOldPass').value;
      const newPass = document.getElementById('pNewPass').value;

      if (newPass && !oldPass) {
        showToast('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u c≈© ƒë·ªÉ ƒë·ªïi m·∫≠t kh·∫©u!', 'warning');
        return;
      }

      showToast('ƒêang c·∫≠p nh·∫≠t...', 'info');

      const res = await callAPI('updateUserProfile', {
        email: state.user.email,
        name: name,
        phone: phone,
        oldPass: oldPass,
        newPass: newPass
      });

      if (res.success) {
        showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
        // Update local state
        state.user.name = name;
        state.user.phone = phone;
        localStorage.setItem('lms_user', JSON.stringify(state.user));

        closeUserProfile();
        renderHome(); // Refresh UI
      } else {
        showToast('L·ªói: ' + res.message, 'error');
      }
    }

    async function callAPI(action, data = {}) {
      try {
        const formData = new URLSearchParams();
        formData.append('action', action);

        // Flatten data object th√†nh form fields
        for (const key in data) {
          if (typeof data[key] === 'object' && data[key] !== null) {
            formData.append(key, JSON.stringify(data[key]));
          } else {
            formData.append(key, data[key]);
          }
        }

        const response = await fetch(API_URL, {
          method: 'POST',
          body: formData  // ‚Üê FormData, kh√¥ng ph·∫£i JSON
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        return await response.json();

      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    const app = document.getElementById('app');
    let state = { view: 'login', course: null, lesson: null, user: null, courses: [] };
    let isTeacher = false;
    let lessonCount = 0;
    let editLessonCount = 0;

    let devToolsDetected = false;
    let warningCount = 0;
    let blurCount = 0;

    function showLoading() {
      const existing = document.getElementById('loader');
      if (existing) return;
      const loader = document.createElement('div');
      loader.id = 'loader';
      loader.textContent = '‚ö° ƒêang t·∫£i...';
      document.body.appendChild(loader);
    }

    function hideLoading() {
      const loader = document.getElementById('loader');
      if (loader) loader.remove();
    }

    // ========== CACHE ==========
    const localCache = {
      data: {},
      get: function (key) {
        if (key === 'homeData') {
          console.log('üî¥ BYPASSING CACHE - Courses are always real-time');
          return null;
        }

        const item = this.data[key];
        if (!item) return null;
        if (Date.now() > item.expiry) {
          delete this.data[key];
          return null;
        }
        console.log('üì¶ Cache hit:', key);
        return item.value;
      },
      set: function (key, value, duration) {
        if (key === 'homeData') {
          console.log('‚è≠Ô∏è SKIP CACHE - Courses remain real-time');
          return;
        }

        this.data[key] = {
          value: value,
          expiry: Date.now() + (duration * 1000)
        };
      },
      clear: function () {
        this.data = {};
        console.log('üóëÔ∏è Cache cleared');
      }
    };

    // ========== SECURITY ==========
    function detectDevTools() {
      const threshold = 160;
      const widthThreshold = window.outerWidth - window.innerWidth > threshold;
      const heightThreshold = window.outerHeight - window.innerHeight > threshold;
      if (!(heightThreshold && widthThreshold) &&
        ((window.Firebug && window.Firebug.chrome && window.Firebug.chrome.isInitialized) ||
          widthThreshold || heightThreshold)) {
        if (!devToolsDetected) {
          devToolsDetected = true;
          handleDevToolsOpen('SIZE_CHANGE');
        }
      }
    }

    document.addEventListener('contextmenu', function (e) {
      if (state.view === 'lesson') {
        e.preventDefault();
        logWarning('RIGHT_CLICK', 'User attempted right-click on video page');
        showSecurityNotice('‚ö†Ô∏è H√†nh ƒë·ªông n√†y ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n!');
        return false;
      }
    });

    document.addEventListener('keydown', function (e) {
      if (state.view !== 'lesson') return;

      if (e.keyCode === 123) {
        e.preventDefault();
        handleDevToolsAttempt('F12_PRESSED');
        return false;
      }

      if ((e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.metaKey && e.altKey && e.keyCode === 73)) {
        e.preventDefault();
        handleDevToolsAttempt('CTRL_SHIFT_I');
        return false;
      }

      if ((e.ctrlKey && e.shiftKey && e.keyCode === 74) || (e.metaKey && e.altKey && e.keyCode === 74)) {
        e.preventDefault();
        handleDevToolsAttempt('CTRL_SHIFT_J');
        return false;
      }

      if ((e.ctrlKey && e.shiftKey && e.keyCode === 67) || (e.metaKey && e.altKey && e.keyCode === 67)) {
        e.preventDefault();
        handleDevToolsAttempt('CTRL_SHIFT_C');
        return false;
      }

      if (e.ctrlKey && e.keyCode === 85) {
        e.preventDefault();
        handleDevToolsAttempt('CTRL_U_VIEW_SOURCE');
        return false;
      }

      if (e.ctrlKey && e.keyCode === 83) {
        e.preventDefault();
        logWarning('SAVE_ATTEMPT', 'User attempted to save page');
        showSecurityNotice('‚ö†Ô∏è Kh√¥ng th·ªÉ l∆∞u n·ªôi dung!');
        return false;
      }
    });

    function handleDevToolsAttempt(method) {
      warningCount++;
      logWarning('DEV_TOOLS_ATTEMPT', 'User attempted to open dev tools via ' + method);
      if (warningCount >= 3) {
        showSecurityNotice('üö® C·∫¢NH B√ÅO: H√†nh vi nghi ng·ªù ƒë√£ ƒë∆∞·ª£c ghi l·∫°i! Admin s·∫Ω xem x√©t t√†i kho·∫£n c·ªßa b·∫°n.');
        setTimeout(function () {
          if (confirm('T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã ƒë√°nh d·∫•u do h√†nh vi nghi ng·ªù. B·∫°n c√≥ mu·ªën quay v·ªÅ trang ch·ªß kh√¥ng?')) {
            warningCount = 0;
            renderHome();
          }
        }, 2000);
      } else {
        showSecurityNotice('‚ö†Ô∏è C·∫£nh b√°o ' + warningCount + '/3: H√†nh ƒë·ªông n√†y vi ph·∫°m ch√≠nh s√°ch!');
      }
    }

    function handleDevToolsOpen(method) {
      logWarning('DEV_TOOLS_DETECTED', 'Dev tools opened via ' + method);
      showSecurityNotice('üö® Dev Tools ƒë√£ ƒë∆∞·ª£c ph√°t hi·ªán! H√†nh ƒë·ªông c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c ghi l·∫°i.');

      const iframe = document.querySelector('#playerWrap iframe');
      if (iframe) {
        iframe.style.filter = 'blur(10px)';
      }
    }

    async function logWarning(type, description) {
      if (!state.user) return;
      const details = {
        description: description,
        course: state.course || '',
        lesson: state.lesson || '',
        browser: navigator.userAgent,
        timestamp: new Date().toISOString()
      };

      try {
        await callAPI('logSecurityWarning', {
          email: state.user.email,
          type: type,
          details: details
        });
        console.log('Warning logged');
      } catch (error) {
        console.error('Log warning failed:', error);
      }
    }

    function showSecurityNotice(message) {
      const existing = document.getElementById('securityNotice');
      if (existing) existing.remove();

      const notice = document.createElement('div');
      notice.id = 'securityNotice';
      notice.style.cssText =
        'position: fixed; top: 20px; left: 50%; transform: translateX(-50%);' +
        'background: rgba(220, 38, 38, 0.95); color: white; padding: 16px 32px;' +
        'border-radius: 8px; font-weight: 700; font-size: 16px; z-index: 10000;' +
        'box-shadow: 0 0 30px rgba(220, 38, 38, 0.6); animation: shake 0.5s; text-transform: uppercase; letter-spacing: 1px;';
      notice.textContent = message;

      document.body.appendChild(notice);

      setTimeout(function () {
        notice.style.transition = 'opacity 0.5s';
        notice.style.opacity = '0';
        setTimeout(function () { notice.remove(); }, 500);
      }, 5000);
    }

    // setInterval(detectDevTools, 1000);
    // window.addEventListener('resize', detectDevTools);

    window.addEventListener('blur', function () {
      if (state.view === 'lesson') {
        blurCount++;
        if (blurCount > 5) {
          logWarning('SUSPICIOUS_ACTIVITY', 'User switched tabs/windows ' + blurCount + ' times during video');
        }
      }
    });

    // ========== AUTH ==========
    function checkAuth() {
      const userData = localStorage.getItem('lms_user');
      if (userData) {
        try {
          state.user = JSON.parse(userData);
          return true;
        } catch (e) {
          localStorage.removeItem('lms_user');
        }
      }
      return false;
    }

    function logout() {
      localStorage.removeItem('lms_user');
      localCache.clear();
      state.user = null;
      state.view = 'login';
      isTeacher = false;
      renderLogin();
    }

    function setUrl(params) {
      const base = location.href.split('?')[0];
      const qs = new URLSearchParams(params).toString();
      history.pushState({}, '', qs ? base + '?' + qs : base);
    }

    function renderLogin() {
      app.innerHTML = '<div class="auth-container">' +
        '<h1 class="auth-title">ƒêƒÇNG NH·∫¨P</h1>' +
        '<div id="loginMsg"></div>' +
        '<form id="loginForm" onsubmit="return false;">' +
        '<div class="form-group">' +
        '<label class="form-label">Email ho·∫∑c S·ªë ƒëi·ªán tho·∫°i</label>' +
        '<input type="text" class="form-input" id="loginCredential" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">M·∫≠t kh·∫©u</label>' +
        '<input type="password" class="form-input" id="loginPassword" required>' +
        '</div>' +
        '<button type="submit" class="form-btn">ƒêƒÉng nh·∫≠p</button>' +
        '</form>' +
        '<div style="text-align:center;margin-top:12px;"><a onclick="forgotPassword()" style="color:#aaa;font-size:13px;cursor:pointer;">Qu√™n m·∫≠t kh·∫©u?</a></div>' +
        '<div class="form-link">Ch∆∞a c√≥ t√†i kho·∫£n? <a onclick="renderRegister()">ƒêƒÉng k√Ω ngay</a></div>' +
        '</div>';

      document.getElementById('loginForm').addEventListener('submit', handleLogin);
    }

    // ========== FORGOT PASSWORD LOGIC ==========
    function forgotPassword() {
      // M·ªü modal
      document.getElementById('modalForgotPassword').classList.add('active');
      backToStep1();
      document.getElementById('forgotMsg').innerHTML = '';
      document.getElementById('resetEmail').value = '';
      document.getElementById('resetOTP').value = '';
      document.getElementById('resetNewPass').value = '';
    }

    function closeModalForgotPassword() {
      document.getElementById('modalForgotPassword').classList.remove('active');
    }

    function backToStep1() {
      document.getElementById('forgotStep1').style.display = 'block';
      document.getElementById('forgotStep2').style.display = 'none';
    }

    async function handleSendOTP() {
      const email = document.getElementById('resetEmail').value.trim();
      const msgDiv = document.getElementById('forgotMsg');

      if (!email) {
        msgDiv.innerHTML = '<div class="alert alert-error">Vui l√≤ng nh·∫≠p email!</div>';
        return;
      }

      msgDiv.innerHTML = '<div class="alert alert-success">ƒêang g·ª≠i OTP...</div>';

      try {
        const result = await callAPI('sendOTP', { email: email });

        if (result.success) {
          msgDiv.innerHTML = '<div class="alert alert-success">' + result.message + '</div>';
          // Chuy·ªÉn sang b∆∞·ªõc 2
          document.getElementById('forgotStep1').style.display = 'none';
          document.getElementById('forgotStep2').style.display = 'block';
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error">L·ªói k·∫øt n·ªëi: ' + error + '</div>';
      }
    }

    async function handleVerifyReset() {
      const email = document.getElementById('resetEmail').value.trim();
      const otp = document.getElementById('resetOTP').value.trim();
      const newPass = document.getElementById('resetNewPass').value.trim();
      const msgDiv = document.getElementById('forgotMsg');

      if (!otp || !newPass) {
        msgDiv.innerHTML = '<div class="alert alert-error">Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!</div>';
        return;
      }

      if (newPass.length < 6) {
        msgDiv.innerHTML = '<div class="alert alert-error">M·∫≠t kh·∫©u m·ªõi ph·∫£i t·ª´ 6 k√Ω t·ª±!</div>';
        return;
      }

      msgDiv.innerHTML = '<div class="alert alert-success">ƒêang x√°c th·ª±c...</div>';

      try {
        const result = await callAPI('verifyOTPAndReset', {
          email: email,
          otp: otp,
          newPassword: newPass
        });

        if (result.success) {
          msgDiv.innerHTML = '<div class="alert alert-success">‚úÖ ' + result.message + '</div>';
          setTimeout(() => {
            closeModalForgotPassword();
            renderLogin();
          }, 2000);
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error">‚ùå ' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error">L·ªói k·∫øt n·ªëi: ' + error + '</div>';
      }
    }

    function renderRegister() {
      app.innerHTML = '<div class="auth-container">' +
        '<h1 class="auth-title">ƒêƒÇNG K√ù</h1>' +
        '<div id="registerMsg"></div>' +
        '<form id="registerForm" onsubmit="return false;">' +
        '<div class="form-group">' +
        '<label class="form-label">H·ªç v√† t√™n</label>' +
        '<input type="text" class="form-input" id="registerName" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Email</label>' +
        '<input type="email" class="form-input" id="registerEmail" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>' +
        '<input type="tel" class="form-input" id="registerPhone" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">M·∫≠t kh·∫©u</label>' +
        '<input type="password" class="form-input" id="registerPassword" required minlength="6">' +
        '</div>' +
        '<button type="submit" class="form-btn">ƒêƒÉng k√Ω</button>' +
        '</form>' +
        '<div class="form-link">ƒê√£ c√≥ t√†i kho·∫£n? <a onclick="renderLogin()">ƒêƒÉng nh·∫≠p</a></div>' +
        '</div>';
      document.getElementById('registerForm').addEventListener('submit', handleRegister);
    }

    async function handleLogin(e) {
      e.preventDefault();
      const credential = document.getElementById('loginCredential').value;
      const password = document.getElementById('loginPassword').value;
      const msgDiv = document.getElementById('loginMsg');

      msgDiv.innerHTML = '<div class="alert alert-success">ƒêang ƒëƒÉng nh·∫≠p...</div>';

      try {
        const result = await callAPI('loginUser', { credential, password });

        if (result.success) {
          msgDiv.innerHTML = '<div class="alert alert-success">' + result.message + '</div>';
          localStorage.setItem('lms_user', JSON.stringify(result.user));
          state.user = result.user;
          setTimeout(function () {
            renderHome();
          }, 1000);
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error">L·ªói k·∫øt n·ªëi: ' + error + '</div>';
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const userData = {
        name: document.getElementById('registerName').value,
        email: document.getElementById('registerEmail').value,
        phone: document.getElementById('registerPhone').value,
        password: document.getElementById('registerPassword').value
      };
      const msgDiv = document.getElementById('registerMsg');

      msgDiv.innerHTML = '<div class="alert alert-success">ƒêang x·ª≠ l√Ω...</div>';

      try {
        const result = await callAPI('registerUser', userData);

        if (result.success) {
          msgDiv.innerHTML = '<div class="alert alert-success">' + result.message + '</div>';
          setTimeout(function () {
            renderLogin();
          }, 2000);
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error">L·ªói: ' + error + '</div>';
      }
    }

    async function checkTeacherPermission() {
      if (!state.user) return;
      // Legacy function kept just in case, but syncUserProfile is preferred
      try {
        const result = await callAPI('checkIsTeacher', { email: state.user.email });
        isTeacher = result;
        if (isTeacher) {
          updateTopbarWithTeacherBtn();
          renderCourseGrid(state.courses || []);
        }
      } catch (error) {
        console.error('Check teacher error:', error);
      }
    }

    async function syncUserProfile() {
      if (!state.user) {
        console.log('‚ö†Ô∏è syncUserProfile: No user in state');
        return;
      }

      try {
        console.log('üîÑ syncUserProfile START - email:', state.user.email);
        const result = await callAPI('getUserProfile', { email: state.user.email });

        console.log('üîÑ syncUserProfile Response:', JSON.stringify(result));

        if (result.success) {
          console.log('‚úÖ Profile synced successfully!');
          console.log('  - allowedCourses:', result.user.allowedCourses);
          console.log('  - isTeacher:', result.isTeacher);

          // Update Local State
          state.user.allowedCourses = result.user.allowedCourses;
          isTeacher = result.isTeacher;

          // Update Storage
          localStorage.setItem('lms_user', JSON.stringify(state.user));

          // UI Updates - Show teacher buttons if applicable
          if (isTeacher) {
            console.log('üë®‚Äçüè´ User IS Teacher - Adding admin buttons...');
            updateTopbarWithTeacherBtn();
          } else {
            console.log('üë§ User is NOT Teacher');
          }

          // Re-render grid with new permissions
          if (state.courses && state.courses.length > 0) {
            console.log('üîÑ Re-rendering course grid with updated permissions...');
            renderCourseGrid(state.courses);
          }
        } else {
          console.log('‚ö†Ô∏è syncUserProfile failed:', result.message);
        }
      } catch (error) {
        console.error('‚ùå Sync profile error:', error);
      }
    }

    function updateTopbarWithTeacherBtn() {
      console.log('üîß updateTopbarWithTeacherBtn called');

      const topbarRight = document.querySelector('.topbar-right');
      if (!topbarRight) {
        console.log('‚ö†Ô∏è topbar-right not found');
        return;
      }

      // Ki·ªÉm tra n·∫øu ƒë√£ c√≥ n√∫t r·ªìi th√¨ kh√¥ng th√™m n·ªØa
      if (document.getElementById('btnQuickAdd')) {
        console.log('‚è≠Ô∏è Teacher buttons already exist');
        return;
      }

      console.log('‚úÖ Adding teacher buttons...');

      const btnQuick = document.createElement('button');
      btnQuick.id = 'btnQuickAdd';
      btnQuick.className = 'btn btn-teacher';
      btnQuick.textContent = '‚ö° Th√™m Nhanh';
      btnQuick.onclick = openModalQuickAdd;
      btnQuick.style.marginRight = '12px';

      const btnDashboard = document.createElement('button');
      btnDashboard.id = 'btnAdminDashboard';
      btnDashboard.className = 'btn btn-teacher';
      btnDashboard.style.background = '#e50914'; // Red accent
      btnDashboard.style.marginRight = '12px';
      btnDashboard.innerHTML = 'üìä Dashboard';
      btnDashboard.onclick = renderAdminDashboard;

      const btnManual = document.createElement('button');
      btnManual.id = 'btnAddCourse';
      btnManual.className = 'btn btn-teacher';
      btnManual.textContent = '+ Th√™m Th·ªß C√¥ng';
      btnManual.onclick = openModalAddCourse;

      // Ch√®n v√†o tr∆∞·ªõc n√∫t "ƒêƒÉng xu·∫•t"
      const logoutBtn = topbarRight.querySelector('.btn-logout');
      if (logoutBtn) {
        topbarRight.insertBefore(btnDashboard, logoutBtn);
        topbarRight.insertBefore(btnQuick, logoutBtn);
        topbarRight.insertBefore(btnManual, logoutBtn);
      } else {
        topbarRight.appendChild(btnDashboard);
        topbarRight.appendChild(btnQuick);
        topbarRight.appendChild(btnManual);
      }

      console.log('‚úÖ Teacher buttons added!');
    }

    // ========== EDIT & DELETE ==========
    async function openEditCourse(courseName, event) {
      if (event) {
        event.stopPropagation();
      }

      showLoading();

      try {
        const result = await callAPI('getCourseForEdit', { courseName });
        hideLoading();

        if (result.success) {
          const data = result.data;

          document.getElementById('editOldCourseName').value = courseName;
          document.getElementById('editCourseName').value = data.courseName;
          document.getElementById('editCourseDesc').value = data.courseDesc || '';
          document.getElementById('editCourseThumbnail').value = data.thumbnail || '';

          const container = document.getElementById('editLessonsContainer');
          container.innerHTML = '';
          editLessonCount = 0;

          data.lessons.forEach(function (lesson) {
            editLessonCount++;
            const lessonDiv = document.createElement('div');
            lessonDiv.className = 'lesson-item';
            lessonDiv.id = 'edit-lesson-' + editLessonCount;
            lessonDiv.innerHTML =
              '<div class="lesson-header">' +
              '<span class="lesson-title">B√†i h·ªçc ' + editLessonCount + '</span>' +
              '<button type="button" class="btn btn-remove" onclick="removeEditLessonField(' + editLessonCount + ')">X√≥a</button>' +
              '</div>' +
              '<div class="form-group">' +
              '<label class="form-label">T√™n b√†i h·ªçc *</label>' +
              '<input type="text" class="form-input edit-lesson-name" value="' + escapeHtml(lesson.name) + '" required>' +
              '</div>' +
              '<div class="form-group">' +
              '<label class="form-label">Video</label>' +
              '<input type="text" class="form-input edit-lesson-video" value="' + escapeHtml(lesson.videoUrl) + '" placeholder="Link Drive ho·∫∑c URL">' +
              '<div class="file-input-group">' +
              '<button type="button" class="btn-pick-file" onclick="pickVideo(' + editLessonCount + ')">üìπ Ch·ªçn t·ª´ Drive</button>' +
              '</div>' +
              '</div>' +
              '<div class="form-group">' +
              '<label class="form-label">T√†i li·ªáu</label>' +
              '<input type="text" class="form-input edit-lesson-material" value="' + escapeHtml(lesson.materialUrl) + '" placeholder="Link Drive ho·∫∑c URL">' +
              '<div class="file-input-group">' +
              '<button type="button" class="btn-pick-file" onclick="pickMaterial(' + editLessonCount + ')">üìÑ Ch·ªçn t·ª´ Drive</button>' +
              '</div>' +
              '</div>';
            container.appendChild(lessonDiv);
          });

          document.getElementById('modalEditCourse').classList.add('active');
          document.getElementById('modalEditMsg').innerHTML = '';
        } else {
          showToast('L·ªói: ' + result.message, 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('L·ªói: ' + error, 'error');
      }
    }

    function closeModalEditCourse() {
      document.getElementById('modalEditCourse').classList.remove('active');
    }

    function addEditLessonField() {
      editLessonCount++;
      const container = document.getElementById('editLessonsContainer');

      const lessonDiv = document.createElement('div');
      lessonDiv.className = 'lesson-item';
      lessonDiv.id = 'edit-lesson-' + editLessonCount;
      lessonDiv.innerHTML =
        '<div class="lesson-header">' +
        '<span class="lesson-title">B√†i h·ªçc ' + editLessonCount + '</span>' +
        '<button type="button" class="btn btn-remove" onclick="removeEditLessonField(' + editLessonCount + ')">X√≥a</button>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">T√™n b√†i h·ªçc *</label>' +
        '<input type="text" class="form-input edit-lesson-name" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Video</label>' +
        '<input type="text" class="form-input edit-lesson-video" placeholder="Link Drive ho·∫∑c URL">' +
        '<div class="file-input-group">' +
        '<button type="button" class="btn-pick-file" onclick="pickVideo(' + editLessonCount + ')">üìπ Ch·ªçn t·ª´ Drive</button>' +
        '</div>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">T√†i li·ªáu</label>' +
        '<input type="text" class="form-input edit-lesson-material" placeholder="Link Drive ho·∫∑c URL">' +
        '<div class="file-input-group">' +
        '<button type="button" class="btn-pick-file" onclick="pickMaterial(' + editLessonCount + ')">üìÑ Ch·ªçn t·ª´ Drive</button>' +
        '</div>' +
        '</div>';
      container.appendChild(lessonDiv);
    }

    function removeEditLessonField(id) {
      const elem = document.getElementById('edit-lesson-' + id);
      if (elem) elem.remove();
    }

    document.getElementById('formEditCourse').addEventListener('submit', async function (e) {
      e.preventDefault();

      const oldCourseName = document.getElementById('editOldCourseName').value;
      const courseName = document.getElementById('editCourseName').value.trim();
      const courseDesc = document.getElementById('editCourseDesc').value.trim();
      const thumbnail = document.getElementById('editCourseThumbnail').value.trim();

      const lessonItems = document.querySelectorAll('#editLessonsContainer .lesson-item');
      const lessons = [];

      lessonItems.forEach(function (item) {
        const name = item.querySelector('.edit-lesson-name').value.trim();
        const video = item.querySelector('.edit-lesson-video').value.trim();
        const material = item.querySelector('.edit-lesson-material').value.trim();

        if (name) {
          lessons.push({
            name: name,
            video: video,
            material: material
          });
        }
      });

      if (lessons.length === 0) {
        document.getElementById('modalEditMsg').innerHTML =
          '<div class="alert alert-error">Vui l√≤ng th√™m √≠t nh·∫•t 1 b√†i h·ªçc!</div>';
        return;
      }

      const courseData = {
        courseName: courseName,
        courseDesc: courseDesc,
        thumbnail: thumbnail,
        lessons: lessons
      };

      document.getElementById('modalEditMsg').innerHTML =
        '<div class="alert alert-success">‚è≥ ƒêang c·∫≠p nh·∫≠t...</div>';

      try {
        const result = await callAPI('updateCourse', { oldCourseName, courseData });

        if (result.success) {
          document.getElementById('modalEditMsg').innerHTML =
            '<div class="alert alert-success">‚úÖ ' + result.message + '</div>';

          localCache.clear();

          setTimeout(function () {
            closeModalEditCourse();
            renderHome();
          }, 1000);
        } else {
          document.getElementById('modalEditMsg').innerHTML =
            '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        document.getElementById('modalEditMsg').innerHTML =
          '<div class="alert alert-error">L·ªói: ' + error + '</div>';
      }
    });

    async function refreshCourseConfirm(courseName, event) {
      if (event) {
        event.stopPropagation();
      }

      if (!confirm('üîÑ REFRESH KH√ìA H·ªåC\n\nL√†m m·ªõi d·ªØ li·ªáu t·ª´ folder Drive c·ªßa kh√≥a h·ªçc "' + courseName + '"?\n\n‚Ä¢ S·∫Ω qu√©t l·∫°i to√†n b·ªô folder Drive\n‚Ä¢ C·∫≠p nh·∫≠t video/b√†i h·ªçc m·ªõi\n‚Ä¢ D·ªØ li·ªáu c≈© s·∫Ω ƒë∆∞·ª£c gi·ªØ nguy√™n')) {
        return;
      }

      showLoading();

      try {
        const result = await callAPI('refreshCourse', { courseName });
        hideLoading();

        if (result.success) {
          localCache.clear();
          showToast('‚úÖ ' + result.message + (result.details ? ' ‚Ä¢ ' + result.details.lessonsCount + ' b√†i' : ''), 'success');
          renderHome();
        } else {
          showToast('‚ùå L·ªói: ' + result.message, 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('‚ùå L·ªói: ' + error, 'error');
      }
    }

    async function deleteCourseConfirm(courseName, event) {
      if (event) {
        event.stopPropagation();
      }

      if (!confirm('‚ö†Ô∏è X√ìA KH√ìA H·ªåC\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a "' + courseName + '"?\n\n‚Ä¢ T·∫•t c·∫£ b√†i h·ªçc s·∫Ω b·ªã x√≥a\n‚Ä¢ Kh√¥ng th·ªÉ ho√†n t√°c')) {
        return;
      }

      showLoading();

      try {
        const result = await callAPI('deleteCourse', { courseName });
        hideLoading();

        if (result.success) {
          localCache.clear();
          showToast('‚úÖ ' + result.message, 'success');
          renderHome();
        } else {
          showToast('‚ùå L·ªói: ' + result.message, 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('‚ùå L·ªói: ' + error, 'error');
      }
    }

    // ========== ADD COURSE ==========
    function openModalAddCourse() {
      document.getElementById('modalAddCourse').classList.add('active');
      document.getElementById('formAddCourse').reset();
      document.getElementById('lessonsContainer').innerHTML = '';
      document.getElementById('modalMsg').innerHTML = '';
      lessonCount = 0;
      addLessonField();
    }

    function closeModalAddCourse() {
      document.getElementById('modalAddCourse').classList.remove('active');
    }

    function addLessonField() {
      lessonCount++;
      const container = document.getElementById('lessonsContainer');

      const lessonDiv = document.createElement('div');
      lessonDiv.className = 'lesson-item';
      lessonDiv.id = 'lesson-' + lessonCount;
      lessonDiv.innerHTML =
        '<div class="lesson-header">' +
        '<span class="lesson-title">B√†i h·ªçc ' + lessonCount + '</span>' +
        '<button type="button" class="btn btn-remove" onclick="removeLessonField(' + lessonCount + ')">X√≥a</button>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">T√™n b√†i h·ªçc *</label>' +
        '<input type="text" class="form-input lesson-name" required>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">Video</label>' +
        '<input type="text" class="form-input lesson-video" placeholder="Link Drive ho·∫∑c URL">' +
        '<div class="file-input-group">' +
        '<button type="button" class="btn-pick-file" onclick="pickVideo(' + lessonCount + ')">üìπ Ch·ªçn t·ª´ Drive</button>' +
        '</div>' +
        '</div>' +
        '<div class="form-group">' +
        '<label class="form-label">T√†i li·ªáu</label>' +
        '<input type="text" class="form-input lesson-material" placeholder="Link Drive ho·∫∑c URL">' +
        '<div class="file-input-group">' +
        '<button type="button" class="btn-pick-file" onclick="pickMaterial(' + lessonCount + ')">üìÑ Ch·ªçn t·ª´ Drive</button>' +
        '</div>' +
        '</div>';
      container.appendChild(lessonDiv);
    }

    function removeLessonField(id) {
      const elem = document.getElementById('lesson-' + id);
      if (elem) elem.remove();
    }

    function pickThumbnail() {
      showToast('‚ÑπÔ∏è M·ªü Drive > Chu·ªôt ph·∫£i file > Get link > Copy & Paste v√†o ƒë√¢y.', 'info');
    }

    function pickVideo(lessonId) {
      showToast('‚ÑπÔ∏è M·ªü Drive > Chu·ªôt ph·∫£i Video > Get link > Copy & Paste v√†o ƒë√¢y.', 'info');
    }

    function pickMaterial(lessonId) {
      showToast('‚ÑπÔ∏è M·ªü Drive > Chu·ªôt ph·∫£i File > Get link > Copy & Paste v√†o ƒë√¢y.', 'info');
    }

    document.getElementById('formAddCourse').addEventListener('submit', async function (e) {
      e.preventDefault();

      const courseName = document.getElementById('courseName').value.trim();
      const courseDesc = document.getElementById('courseDesc').value.trim();
      const thumbnail = document.getElementById('courseThumbnail').value.trim();

      const lessonItems = document.querySelectorAll('.lesson-item');
      const lessons = [];

      lessonItems.forEach(function (item) {
        const name = item.querySelector('.lesson-name').value.trim();
        const video = item.querySelector('.lesson-video').value.trim();
        const material = item.querySelector('.lesson-material').value.trim();

        if (name) {
          lessons.push({
            name: name,
            video: video,
            material: material
          });
        }
      });

      if (lessons.length === 0) {
        document.getElementById('modalMsg').innerHTML =
          '<div class="alert alert-error">Vui l√≤ng th√™m √≠t nh·∫•t 1 b√†i h·ªçc!</div>';
        return;
      }

      const courseData = {
        courseName: courseName,
        courseDesc: courseDesc,
        thumbnail: thumbnail,
        lessons: lessons
      };

      document.getElementById('modalMsg').innerHTML =
        '<div class="alert alert-success">ƒêang t·∫°o kh√≥a h·ªçc...</div>';

      try {
        const result = await callAPI('addCourse', courseData);

        if (result.success) {
          document.getElementById('modalMsg').innerHTML =
            '<div class="alert alert-success">' + result.message + '</div>';
          localCache.clear();
          setTimeout(function () {
            closeModalAddCourse();
            renderHome();
          }, 2000);
        } else {
          document.getElementById('modalMsg').innerHTML =
            '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        document.getElementById('modalMsg').innerHTML =
          '<div class="alert alert-error">L·ªói: ' + error + '</div>';
      }
    });

    document.getElementById('modalAddCourse').addEventListener('click', function (e) {
      if (e.target === this) {
        closeModalAddCourse();
      }
    });

    document.getElementById('modalEditCourse').addEventListener('click', function (e) {
      if (e.target === this) {
        closeModalEditCourse();
      }
    });

    // ========== QUICK ADD ==========
    function openModalQuickAdd() {
      document.getElementById('modalQuickAdd').classList.add('active');
      document.getElementById('formQuickAdd').reset();
      document.getElementById('quickAddMsg').innerHTML = '';
    }

    function closeModalQuickAdd() {
      document.getElementById('modalQuickAdd').classList.remove('active');
    }

    document.getElementById('formQuickAdd').addEventListener('submit', async function (e) {
      e.preventDefault();

      const folderUrl = document.getElementById('quickFolderUrl').value.trim();
      const courseDesc = document.getElementById('quickCourseDesc').value.trim();
      const msgDiv = document.getElementById('quickAddMsg');

      if (!folderUrl) {
        msgDiv.innerHTML = '<div class="alert alert-error">Vui l√≤ng nh·∫≠p link folder!</div>';
        return;
      }

      msgDiv.innerHTML = '<div class="alert alert-success">‚è≥ ƒêang qu√©t folder...</div>';

      try {
        const result = await callAPI('quickAddCourseFromFolder', { folderUrl, courseDesc });

        if (result.success) {
          msgDiv.innerHTML =
            '<div class="alert alert-success">' +
            '<strong>‚úÖ ' + result.message + '</strong><br>' +
            (result.details ?
              '<div style="margin-top:8px;font-size:13px;">' +
              '‚Ä¢ Kh√≥a h·ªçc: ' + result.details.courseName + '<br>' +
              '‚Ä¢ S·ªë b√†i h·ªçc: ' + result.details.lessonsCount +
              '</div>' : '') +
            '</div>';

          localCache.clear();
          localStorage.removeItem(HOME_CACHE_KEY);

          setTimeout(function () {
            closeModalQuickAdd();
            renderHome(true);
          }, 3000);
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error">‚ùå ' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error">‚ùå L·ªói: ' + error + '</div>';
      }
    });

    document.getElementById('modalQuickAdd').addEventListener('click', function (e) {
      if (e.target === this) {
        closeModalQuickAdd();
      }
    });

    // ========== ADD STUDENT ==========
    function openModalAddStudent(courseName, courseCode, event) {
      if (event) event.stopPropagation();

      // Ki·ªÉm tra n·∫øu kh√≥a h·ªçc ch∆∞a c√≥ m√£
      if (!courseCode || courseCode === '' || courseCode === 'undefined') {
        showToast('‚ö†Ô∏è Kh√≥a h·ªçc "' + courseName + '" ch∆∞a c√≥ m√£! Vui l√≤ng th√™m m√£ ·ªü Sheet Courses.', 'warning');
        return;
      }

      document.getElementById('modalAddStudent').classList.add('active');
      document.getElementById('addStudentCourseName').value = courseCode;
      document.getElementById('lblCourseName').textContent = courseName + ' (M√£: ' + courseCode + ')';
      document.getElementById('listEmails').value = '';
      document.getElementById('addStudentMsg').innerHTML = '';
    }

    function closeModalAddStudent() {
      document.getElementById('modalAddStudent').classList.remove('active');
    }

    document.getElementById('formAddStudent').addEventListener('submit', async function (e) {
      e.preventDefault();
      const courseCode = document.getElementById('addStudentCourseName').value; // ƒê√¢y l√† courseCode
      const emails = document.getElementById('listEmails').value;
      const msgDiv = document.getElementById('addStudentMsg');

      if (!emails.trim()) {
        msgDiv.innerHTML = '<div class="alert alert-error">Vui l√≤ng nh·∫≠p email!</div>';
        return;
      }

      if (!courseCode) {
        msgDiv.innerHTML = '<div class="alert alert-error">Kh√≥a h·ªçc ch∆∞a c√≥ m√£! Vui l√≤ng th√™m m√£ trong Sheet Courses c·ªôt H.</div>';
        return;
      }

      msgDiv.innerHTML = '<div class="alert alert-success">‚è≥ ƒêang x·ª≠ l√Ω...</div>';

      try {
        // G·ª≠i courseCode thay v√¨ courseName
        const result = await callAPI('addStudentsToCourse', { courseCode, emails });
        if (result.success) {
          msgDiv.innerHTML = '<div class="alert alert-success">‚úÖ ' + result.message + '</div>';
          setTimeout(() => closeModalAddStudent(), 2000);
        } else {
          msgDiv.innerHTML = '<div class="alert alert-error">' + result.message + '</div>';
        }
      } catch (error) {
        msgDiv.innerHTML = '<div class="alert alert-error">L·ªói: ' + error + '</div>';
      }
    });

    document.getElementById('modalAddStudent').addEventListener('click', function (e) {
      if (e.target === this) closeModalAddStudent();
    });

    // ========== RENDER HOME (OPTIMIZED WITH CACHE) ==========
    const HOME_CACHE_KEY = 'lms_home_cache';

    async function renderHome(forceRefresh = false) {
      state.view = 'home';
      setUrl({});

      // Clean up old elements
      const adminSidebar = document.getElementById('adminSidebar');
      if (adminSidebar) adminSidebar.remove();

      // 1. TEACHER LAYOUT (SIDEBAR)
      if (isTeacher) {
        app.innerHTML = `
            <div class="admin-layout">
               <!-- SIDEBAR -->
               <div class="admin-sidebar" style="background:var(--bg-900); border-right:1px solid var(--border)">
                  <div class="admin-top" style="padding:24px; border-bottom:1px solid var(--border-light)">
                     <div class="logo" style="font-size:20px; color:var(--brand-red)">ACADEMY <span style="color:var(--text-primary); font-weight:400">ADMIN</span></div>
                  </div>
                  <div class="admin-menu" style="padding:16px">
                     <div class="menu-item active" style="margin-bottom:8px">
                        <span class="menu-icon"><i data-lucide="layout-grid"></i></span> Kh√≥a H·ªçc
                     </div>
                     <div class="menu-item" onclick="renderAdminDashboard()" style="margin-bottom:8px">
                        <span class="menu-icon"><i data-lucide="bar-chart-2"></i></span> Th·ªëng k√™
                     </div>
                     <div class="menu-item" onclick="logout()" style="margin-top:24px; color:var(--text-muted)">
                        <span class="menu-icon"><i data-lucide="log-out"></i></span> ƒêƒÉng xu·∫•t
                     </div>
                  </div>
                  <div class="sidebar-footer" style="margin-top:auto; padding:24px; border-top:1px solid var(--border-light)">
                     <div class="user-mini" style="display:flex; align-items:center; gap:12px">
                        <div class="avatar" style="width:36px; height:36px; background:var(--bg-800); border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid var(--border)">
                           <i data-lucide="user" style="width:16px"></i>
                        </div>
                        <div style="font-size:13px">
                           <div style="font-weight:600; color:var(--text-primary)">${escapeHtml(state.user.name)}</div>
                           <div style="color:var(--text-muted); font-size:11px">Instructor</div>
                        </div>
                     </div>
                  </div>
               </div>
               
               <!-- MAIN CONTENT -->
               <div class="admin-main" style="background:var(--bg-950)">
                  <!-- HEADER: Search + Actions -->
                  <div class="admin-header topbar" style="position:sticky; top:0; z-index:50; padding:16px 32px; height:auto; border-bottom:1px solid var(--border)">
                     <div class="search-wrapper" style="margin:0; width:100%; max-width:400px; background:var(--bg-900)">
                        <div class="search-icon"><i data-lucide="search"></i></div>
                        <input type="text" class="search-input" placeholder="T√¨m ki·∫øm nhanh..." 
                               oninput="handleSearch(this.value)" onfocus="handleSearch(this.value)">
                        <div class="search-dropdown" id="searchDropdown"></div>
                     </div>
                     
                     <div class="header-actions" style="display:flex; gap:12px; margin-left:auto">
                        <button class="btn btn-teacher" onclick="openModalQuickAdd()"><i data-lucide="zap" style="width:16px; margin-right:8px"></i> Th√™m Nhanh</button>
                        <button class="btn" style="background:var(--bg-800); border-color:var(--border)" onclick="openModalAddCourse()"><i data-lucide="plus" style="width:16px; margin-right:8px"></i> Th·ªß C√¥ng</button>
                        <button class="btn-circle" onclick="renderHome(true)"><i data-lucide="rotate-cw"></i></button>
                     </div>
                  </div>
                  
                  <!-- DASHBOARD HERO -->
                  <div style="padding:32px 32px 0;">
                     <h2 style="font-size:24px; font-weight:700; margin-bottom:8px">Qu·∫£n l√Ω n·ªôi dung</h2>
                     <p style="color:var(--text-muted)">Qu·∫£n l√Ω kh√≥a h·ªçc, b√†i gi·∫£ng v√† h·ªçc vi√™n c·ªßa b·∫°n.</p>
                  </div>

                  <!-- COURSE GRID -->
                  <div class="admin-content" style="padding:32px">
                     <div id="homeGrid" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr))"></div>
                  </div>
               </div>
               
               <!-- MODALS -->
               <div class="profile-modal-overlay" id="modalUserProfile" onclick="if(event.target===this) closeUserProfile()">
                   <div class="profile-modal"><div id="userProfileContent"></div></div>
               </div>
            </div>
          `;
      }
      // 2. STUDENT LAYOUT (TOPBAR - GI·ªÆ NGUY√äN HO·∫∂C T·ªêI ∆ØU SAU)
      else {
        // STUDENT LAYOUT - NEW DESIGN
        const firstName = state.user.name ? state.user.name.split(' ')[0] : 'B·∫°n';

        app.innerHTML = `
          <!-- TOPBAR -->
          <div class="topbar">
             <div class="topbar-left">
                <div class="logo">ACADEMY</div>
             </div>
             
             <div class="search-wrapper">
                <div class="search-icon"><i data-lucide="search"></i></div>
                <input type="text" class="search-input" placeholder="T√¨m ki·∫øm b√†i h·ªçc..." oninput="handleSearch(this.value)">
                <div class="search-dropdown" id="searchDropdown"></div>
             </div>

             <div class="topbar-right">
                <button class="btn-circle" onclick="renderHome(true)" title="L√†m m·ªõi"><i data-lucide="rotate-cw"></i></button>
                <div class="user-info" onclick="openPersonalProfile()" style="cursor:pointer">
                   <div style="width:32px;height:32px;border-radius:50%;background:var(--bg-800);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--text-primary)">
                      <i data-lucide="user"></i>
                   </div>
                   <span style="font-size:13px; font-weight:600; margin-left:8px; display:none; @media(min-width:768px){display:inline}">${escapeHtml(state.user.name)}</span>
                </div>
                <!-- <button class="btn btn-logout" onclick="logout()"><i data-lucide="log-out"></i></button> -->
             </div>
          </div>
          
          <!-- HERO SECTION -->
          <div class="hero-section">
             <div class="hero-welcome">
                <div class="hero-title">Xin ch√†o, ${escapeHtml(firstName)} üëã</div>
                <div class="hero-subtitle">S·∫µn s√†ng b·ª©t ph√° h√¥m nay ch∆∞a?</div>
             </div>
             
             <!-- QUICK STATS -->
             <div class="quick-stats">
                <div class="stat-box">
                   <div class="stat-icon"><i data-lucide="book-open"></i></div>
                   <div class="stat-info">
                      <h4 id="statTotalCourses">--</h4>
                      <p>Kh√≥a h·ªçc</p>
                   </div>
                </div>
                <div class="stat-box">
                   <div class="stat-icon"><i data-lucide="check-circle-2"></i></div>
                   <div class="stat-info">
                      <h4 id="statCompleted">--</h4>
                      <p>ƒê√£ ho√†n th√†nh</p>
                   </div>
                </div>
                <div class="stat-box">
                   <div class="stat-icon"><i data-lucide="zap"></i></div>
                   <div class="stat-info">
                      <h4 id="statActive">--</h4>
                      <p>ƒêang h·ªçc</p>
                   </div>
                </div>
                <div class="stat-box" style="border-color:var(--brand-red); background:rgba(220,38,38,0.05)">
                   <div class="stat-icon" style="background:var(--brand-red); color:white"><i data-lucide="trophy"></i></div>
                   <div class="stat-info">
                      <h4 id="statPoints">PRO</h4>
                      <p>Th√†nh vi√™n</p>
                   </div>
                </div>
             </div>
          </div>

          <!-- CONTINUE LEARNING (FEATURED) -->
          <div id="featuredCourseArea"></div>

          <!-- ALL COURSES -->
          <div class="section-header">
             <div class="section-title">
                <i data-lucide="grid" style="color:var(--brand-red)"></i>
                T·∫•t c·∫£ kh√≥a h·ªçc
             </div>
          </div>
          
          <div id="homeGrid" class="grid" style="padding: 0 4% 60px; max-width:1400px; margin:0 auto"></div>

          <!-- MODAL PROFILE -->
          <div class="profile-modal-overlay" id="modalUserProfile" onclick="if(event.target===this) closeUserProfile()">
             <div class="profile-modal"><div id="userProfileContent"></div></div>
          </div>
        `;
      }

      console.log('üîÑ renderHome START (Optimized with Cache)...');

      // Check localStorage cache first (unless forceRefresh)
      if (!forceRefresh) {
        const cached = localStorage.getItem(HOME_CACHE_KEY);
        if (cached) {
          try {
            const parsed = JSON.parse(cached);
            if (Date.now() < parsed.expiry) {
              console.log('‚ö° Home from localStorage cache!');
              const indicator = document.getElementById('homeCacheIndicator');
              if (indicator) indicator.textContent = '‚ö° Instant';
              processHomeData(parsed.data, false);
              return;
            }
          } catch (e) { /* cache invalid */ }
        }
      }

      try {
        const result = await callAPI('getHomeDataWithProfile', { email: state.user.email });

        if (!result.success) throw new Error(result.message || 'API failed');

        // Save to cache
        localStorage.setItem(HOME_CACHE_KEY, JSON.stringify({
          data: result,
          expiry: Date.now() + DASHBOARD_CACHE_DURATION
        }));

        const indicator = document.getElementById('homeCacheIndicator');
        if (indicator) indicator.textContent = '‚ú® Fresh';

        processHomeData(result, true);

      } catch (error) {
        console.error('‚ùå renderHome ERROR:', error);
        hideLoading();
        app.innerHTML = '<div style="color:#ff4444;text-align:center;margin-top:100px;font-weight:700;">L·ªói: ' + error + '</div>';
      }
    }

    // Process home data (reusable for cache and fresh)
    function processHomeData(result, isFresh) {
      // C·∫≠p nh·∫≠t profile & quy·ªÅn
      if (result.profile) {
        const prevTeacher = isTeacher;
        if (result.profile.user) {
          state.user.allowedCourses = result.profile.user.allowedCourses || '';
          localStorage.setItem('lms_user', JSON.stringify(state.user));
        }
        isTeacher = result.profile.isTeacher;
        console.log('‚úÖ Profile loaded - isTeacher:', isTeacher);

        // N·∫øu tr·∫°ng th√°i Teacher thay ƒë·ªïi (Student -> Teacher), render l·∫°i ƒë·ªÉ hi·ªán Sidebar
        if (!prevTeacher && isTeacher) {
          console.log('üîÑ Detected Teacher permission -> Switching layout...');
          // Clear cache to force re-render with correct layout
          localStorage.removeItem(HOME_CACHE_KEY);
          renderHome();
          return;
        }
      }

      const courses = result.courses || [];
      state.courses = courses;

      // UPDATE STATS & HERO (STUDENT ONLY)
      if (!isTeacher) {
        const total = courses.length;
        const completed = courses.filter(c => c.progress === 100).length;
        const active = courses.filter(c => c.progress > 0 && c.progress < 100).length;

        const elTotal = document.getElementById('statTotalCourses');
        if (elTotal) elTotal.innerText = total < 10 ? '0' + total : total;

        const elCompleted = document.getElementById('statCompleted');
        if (elCompleted) elCompleted.innerText = completed < 10 ? '0' + completed : completed;

        const elActive = document.getElementById('statActive');
        if (elActive) elActive.innerText = active < 10 ? '0' + active : active;

        // Render Featured Course (First active or first available)
        const featured = courses.find(c => c.progress > 0 && c.progress < 100) || (courses.length > 0 ? courses[0] : null);
        const featuredArea = document.getElementById('featuredCourseArea');

        if (featured && featuredArea) {
          const progress = featured.progress || 0;
          featuredArea.innerHTML = `
                <div class="featured-card" onclick="openCourse('${featured.courseName}')" style="cursor:pointer">
                   <img src="${convertDriveUrl(featured.thumbnailUrl)}" class="featured-thumb" 
                        onerror="if(this.src.includes('thumbnail?')) { this.src = 'https://drive.google.com/uc?export=view&id=' + '${convertDriveUrl(featured.thumbnailUrl)}'.split('id=')[1].split('&')[0]; } else { this.src='https://via.placeholder.com/800x450?text=Course'; }">
                   <div class="featured-content">
                      <div class="featured-badge">${progress > 0 ? 'ƒêANG H·ªåC' : 'KH√ìA H·ªåC M·ªöI'}</div>
                      <h3 style="font-size:28px; font-weight:700; margin-bottom:12px; line-height:1.3; color:var(--text-primary)">
                        ${escapeHtml(featured.courseName)}
                      </h3>
                      <p style="color:var(--text-muted); margin-bottom:24px; line-height:1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        ${progress > 0 ? 'Ti·∫øp t·ª•c h√†nh tr√¨nh chinh ph·ª•c ki·∫øn th·ª©c ngay b√¢y gi·ªù.' : 'Kh√°m ph√° n·ªôi dung m·ªõi v√† n√¢ng cao k·ªπ nƒÉng c·ªßa b·∫°n.'}
                      </p>
                      
                      <div style="margin-bottom:24px; width:100%; max-width:400px">
                         <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px; font-weight:600">
                            <span style="color:var(--text-secondary)">Ti·∫øn ƒë·ªô</span>
                            <span style="color:var(--brand-red)">${progress}%</span>
                         </div>
                         <div class="progress-bar" style="height:6px; background:var(--bg-700)">
                            <div class="progress-fill" style="width:${progress}%; height:100%; border-radius:10px; background:var(--brand-red)"></div>
                         </div>
                      </div>
                      
                      <button class="btn btn-red" style="width:fit-content; padding:12px 32px; border-radius:30px; font-weight:700">
                         ${progress > 0 ? 'TI·∫æP T·ª§C H·ªåC' : 'B·∫ÆT ƒê·∫¶U NGAY'} 
                         <i data-lucide="arrow-right" style="margin-left:8px; width:16px; vertical-align:middle; display:inline-block"></i>
                      </button>
                   </div>
                </div>
             `;
        }
      }

      if (courses.length === 0) {
        const grid = document.getElementById('homeGrid');
        if (grid) {
          grid.innerHTML = '<div style="text-align:center;padding:60px;color:var(--text-muted);grid-column:1/-1;">' +
            '<div style="font-size:48px;margin-bottom:16px;opacity:0.5">üìö</div>' +
            '<div style="font-size:18px;font-weight:600;">Ch∆∞a c√≥ kh√≥a h·ªçc n√†o</div>' +
            '</div>';
        }
      } else {
        renderCourseGrid(courses);
      }

      hideLoading();
      if (window.lucide) lucide.createIcons();
    }

    function renderCourseGrid(courses) {
      const grid = document.getElementById('homeGrid');
      if (!grid) return;

      // Helper: Normalize string for comparison
      function normalizeStr(str) {
        return String(str)
          .trim()
          .normalize('NFC')
          .replace(/\s+/g, ' ')
          .toLowerCase();
      }

      // L·∫•y danh s√°ch m√£ kh√≥a h·ªçc ƒë∆∞·ª£c ph√©p (K1, K2...)
      let allowedCodes = [];
      if (state.user && state.user.allowedCourses) {
        allowedCodes = state.user.allowedCourses.split(',').map(s => s.trim().toUpperCase());
      }

      // üîç DEBUG: Log permission info
      console.log('üîç DEBUG - User allowed codes:', allowedCodes);
      console.log('üîç DEBUG - Is Teacher:', isTeacher);
      console.log('üîç DEBUG - All courses:', courses.map(c => c.courseName + ' (' + (c.courseCode || 'N/A') + ')'));

      const fragment = document.createDocumentFragment();
      courses.forEach(function (c) {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.course = c.courseName;

        // Ki·ªÉm tra quy·ªÅn b·∫±ng m√£ kh√≥a h·ªçc (K1, K2...)
        const courseCode = (c.courseCode || '').toUpperCase();
        const isAllowed = isTeacher || allowedCodes.includes(courseCode);

        // üîç DEBUG
        console.log('üîç Course: ' + c.courseName + ' Code: ' + courseCode + ' | Allowed: ' + isAllowed);

        let overlay = '';
        if (!isAllowed) {
          card.classList.add('locked');
          overlay = '<div class="locked-overlay"><div class="locked-icon">üîí</div><div>CH∆ØA M·ªû KH√ìA</div></div>';
        }

        const thumb = c.thumbnailUrl
          ? '<img class="thumb" src="' + toImgUrl(c.thumbnailUrl) + '" loading="lazy" />'
          : '<div class="thumb"></div>';

        const actions = isTeacher ?
          '<div class="course-actions">' +
          '<div class="btn-icon btn-report" onclick="openCourseReport(\'' + escapeHtml(c.courseName).replace(/'/g, "\\'") + '\', \'' + escapeHtml(courseCode).replace(/'/g, "\\'") + '\', event)" title="B√°o c√°o"><i data-lucide="bar-chart-2"></i></div>' +
          '<div class="btn-icon btn-add-student" onclick="openModalAddStudent(\'' + escapeHtml(c.courseName).replace(/'/g, "\\'") + '\', \'' + escapeHtml(courseCode).replace(/'/g, "\\'") + '\', event)" title="Th√™m h·ªçc vi√™n"><i data-lucide="user-plus"></i></div>' +
          '<div class="btn-icon btn-refresh" onclick="refreshCourseConfirm(\'' + escapeHtml(c.courseName).replace(/'/g, "\\'") + '\', event)" title="Refresh kh√≥a h·ªçc"><i data-lucide="refresh-cw"></i></div>' +
          '<div class="btn-icon btn-edit" onclick="openEditCourse(\'' + escapeHtml(c.courseName).replace(/'/g, "\\'") + '\', event)" title="Ch·ªânh s·ª≠a"><i data-lucide="pencil"></i></div>' +
          '<div class="btn-icon btn-delete" onclick="deleteCourseConfirm(\'' + escapeHtml(c.courseName).replace(/'/g, "\\'") + '\', event)" title="X√≥a"><i data-lucide="trash-2"></i></div>' +
          '</div>' : '';

        card.innerHTML = overlay + thumb + actions +
          '<h3>' + escapeHtml(c.courseName) + '</h3>' +
          '<div class="muted">' + escapeHtml(c.courseDesc || 'Kh√°m ph√° n·ªôi dung kh√≥a h·ªçc') + '</div>';

        card.addEventListener('click', function (e) {
          if (!e.target.closest('.course-actions')) {
            if (isAllowed) {
              openCourse(c.courseName);
            } else {
              showToast('üîí B·∫°n ch∆∞a ƒëƒÉng k√Ω kh√≥a h·ªçc n√†y!', 'warning');
            }
          }
        });

        fragment.appendChild(card);
      });

      grid.innerHTML = '';
      grid.appendChild(fragment);

      // Init icons
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    async function openCourse(courseName) {
      showLoading();
      state.view = 'course';
      state.course = courseName;
      state.lesson = null;
      setUrl({ course: courseName });

      app.innerHTML = '<div class="topbar">' +
        '<div class="topbar-left">' +
        '<button class="btn" id="backBtn">‚Üê Trang ch·ªß</button>' +
        '<h2>' + escapeHtml(courseName) + '</h2>' +
        '</div>' +
        '<div class="topbar-right">' +
        '<div class="user-info" onclick="openPersonalProfile()" style="cursor:pointer" title="Xem h·ªì s∆° c√° nh√¢n">üë§ ' + escapeHtml(state.user.name) + '</div>' +
        '<button class="btn btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>' +
        '</div>' +
        '</div>' +
        '<div id="courseDesc" class="muted"></div>' +
        '<h3>B√ÄI H·ªåC</h3>' +
        '<div id="lessonGrid" class="lesson-grid"></div>';

      document.getElementById('backBtn').onclick = function () {
        state = { view: 'home', user: state.user };
        setUrl({});
        renderHome();
      };

      const cacheKey = 'course_' + courseName;
      const cached = localCache.get(cacheKey);
      if (cached) {
        renderCourseContent(cached);
        hideLoading();
        if (isTeacher) updateTopbarWithTeacherBtn();
        return;
      }

      try {
        const data = await callAPI('getCourseData', { courseName });
        localCache.set(cacheKey, data, 180);
        renderCourseContent(data);
        hideLoading();
      } catch (error) {
        hideLoading();
        showToast('L·ªói: ' + error, 'error');
      }

      if (isTeacher) updateTopbarWithTeacherBtn();
    }

    function renderCourseContent(data) {
      document.getElementById('courseDesc').textContent = data.courseDesc || 'Ch·ªçn b√†i h·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu';
      const grid = document.getElementById('lessonGrid');
      if (!grid) return;

      const fragment = document.createDocumentFragment();
      data.lessons.forEach(function (ls) {
        const lessonDiv = document.createElement('div');
        lessonDiv.className = 'lesson';
        lessonDiv.dataset.idx = ls.index;
        lessonDiv.innerHTML =
          '<div class="muted">B√ÄI ' + ls.index + '</div>' +
          '<div>' + escapeHtml(ls.lessonName) + '</div>';

        lessonDiv.addEventListener('click', function () {
          openLesson(data.courseName, ls.index);
        });

        fragment.appendChild(lessonDiv);
      });

      grid.innerHTML = '';
      grid.appendChild(fragment);
    }


    // ========== LESSON VIEW (FOCUS MODE) ==========

    function switchLessonTab(tabId, btn) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

      document.getElementById('tab-' + tabId).classList.add('active');
      btn.classList.add('active');
    }

    async function openLesson(courseName, lessonIndex) {
      // 1. Setup UI Shell (Focus Mode)
      state.view = 'lesson';
      state.course = courseName;
      state.lesson = lessonIndex;
      setUrl({ course: courseName, lesson: lessonIndex });

      app.innerHTML = `
        <!-- FOCUS HEADER -->
        <div class="focus-header">
           <div class="focus-title">
              <div class="btn-circle" id="backCourseBtn" title="Back to Course">
                 <i data-lucide="chevron-left"></i>
              </div>
              <span>${escapeHtml(courseName)}</span>
           </div>
           
           <div class="user-info" style="display:flex;align-items:center;gap:12px">
              <div style="text-align:right">
                 <div style="font-size:12px;color:var(--text-muted)">Ti·∫øn ƒë·ªô</div>
                 <div style="font-weight:700;color:var(--brand-red)" id="headerProgress">0%</div>
              </div>
              <div class="btn-circle" onclick="toggleTheme()" title="Settings">
                 <i data-lucide="settings"></i>
              </div>
              <div class="btn-circle" onclick="renderHome()" title="Home">
                 <i data-lucide="x"></i>
              </div>
           </div>
        </div>

        <!-- MAIN LAYOUT -->
        <div class="lesson-layout">
           <!-- LEFT: VIDEO & TABS -->
           <div class="lesson-main">
              <!-- Video Player -->
              <div id="playerWrap" class="video-container"></div>
              
              <!-- Bento Tabs Section -->
              <div class="bento-tabs">
                 <div class="tab-header">
                    <button class="tab-btn active" onclick="switchLessonTab('overview', this)">T·ªïng quan</button>
                    <button class="tab-btn" onclick="switchLessonTab('qa', this)">H·ªèi ƒë√°p</button>
                    <button class="tab-btn" onclick="switchLessonTab('materials', this)">T√†i li·ªáu</button>
                    <button class="tab-btn" onclick="switchLessonTab('notes', this)">Ghi ch√∫</button>
                 </div>
                 
                 <!-- Tab Contents -->
                 <div id="tab-overview" class="tab-content active">
                    <h2 id="lessonTitle" style="margin-bottom:16px;font-size:24px">ƒêang t·∫£i...</h2>
                    <p id="lessonDesc" style="color:var(--text-muted);font-size:14px;line-height:1.6">
                       M√¥ t·∫£ b√†i h·ªçc ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t.
                    </p>
                 </div>
                 
                 <div id="tab-qa" class="tab-content">
                    <div class="muted">T√≠nh nƒÉng h·ªèi ƒë√°p ƒëang ph√°t tri·ªÉn...</div>
                 </div>
                 
                 <div id="tab-materials" class="tab-content">
                    <div id="materialsArea">
                       <div class="muted">ƒêang t·∫£i t√†i li·ªáu...</div>
                    </div>
                 </div>
                 
                 <div id="tab-notes" class="tab-content">
                    <div class="muted">T√≠nh nƒÉng ghi ch√∫ ƒëang ph√°t tri·ªÉn...</div>
                 </div>
              </div>
           </div>
           
           <!-- RIGHT: PLAYLIST SIDEBAR -->
           <div class="lesson-sidebar">
              <div class="playlist-header">
                 <h3 style="font-size:16px">N·ªôi dung kh√≥a h·ªçc</h3>
                 <div style="font-size:12px;color:var(--text-muted)" id="courseTotalLessons">0 b√†i h·ªçc</div>
              </div>
              
              <div class="playlist-content" id="sidebarLessonList">
                 <!-- Playlist items injected here -->
              </div>
              
              <div class="playlist-footer" id="completeBtnContainer">
                 <!-- Next button injected here -->
              </div>
           </div>
        </div>
      `;

      // Initialize Icons
      if (window.lucide) lucide.createIcons();

      document.getElementById('backCourseBtn').onclick = function () { openCourse(courseName); };


      const cacheKey = 'course_' + courseName;
      let courseData = localCache.get(cacheKey);

      // --- LOGIC M·ªöI: OPTIMISTIC UI ---

      // B∆∞·ªõc 1: Render n·ªôi dung b√†i h·ªçc ngay n·∫øu c√≥ Cache (Video, Material, List b√†i)
      if (courseData) {
        renderLessonShell(courseData, lessonIndex);
      } else {
        showLoading(); // Ch·ªâ hi·ªán loading n·∫øu ch∆∞a c√≥ data kh√≥a h·ªçc
      }

      // B∆∞·ªõc 2: Fetch Data m·ªõi (n·∫øu c·∫ßn) & Fetch Progress (Ch·∫°y ng·∫ßm)
      try {
        if (!courseData) {
          courseData = await callAPI('getCourseData', { courseName });
          localCache.set(cacheKey, courseData, 180);
          hideLoading();
          renderLessonShell(courseData, lessonIndex);
        }

        // === IMPORTANT: Store courseData globally for completion tracking ===
        if (!window._currentCourseData) window._currentCourseData = {};
        window._currentCourseData[courseData.courseCode] = courseData;

        // B∆∞·ªõc 3: Fetch Progress NG·∫¶M (Kh√¥ng ch·∫∑n UI)
        fetchAndRenderProgress(courseData.courseCode, lessonIndex, courseData);

      } catch (error) {
        hideLoading();
        showToast('L·ªói: ' + error, 'error');
      }

      if (isTeacher) updateTopbarWithTeacherBtn();
    }

    // H√†m t√°ch bi·ªát: Ch·ªâ fetch v√† update progress tick xanh
    async function fetchAndRenderProgress(courseCode, lessonIndex, courseData) {
      if (!courseCode) return;
      try {
        const pData = await callAPI('getProgress', { email: state.user.email, courseCode: courseCode });
        if (pData.success) {
          // Cache progress for optimistic updates
          if (!window._cachedProgressList) window._cachedProgressList = {};
          window._cachedProgressList[courseCode] = pData.progress || [];

          updateLessonProgress(pData.progress, lessonIndex, courseData);
        }
      } catch (e) { console.warn('Fetch progress background error', e); }
    }

    // H√†m t√°ch bi·ªát: Update UI sau khi c√≥ progress
    // H√†m t√°ch bi·ªát: Update UI sau khi c√≥ progress
    function updateLessonProgress(progressList, currentLessonIdx, courseData) {
      if (!courseData) return;

      // 1. Calculate & Update Header Progress
      let completedParams = 0;
      if (progressList) {
        completedParams = progressList.filter(p => p.completedAt && String(p.completedAt).trim() !== '').length;
      }
      const total = courseData.lessons.length;
      const percent = total > 0 ? Math.round((completedParams / total) * 100) : 0;

      const headerProgress = document.getElementById('headerProgress');
      if (headerProgress) headerProgress.innerText = percent + '%';

      // 2. Find Next Lesson
      const nextLesson = courseData.lessons.find(l => l.index === currentLessonIdx + 1);

      // 3. Update Sidebar Footer (Complete + Next Buttons)
      const footerContainer = document.getElementById('completeBtnContainer');
      if (footerContainer) {
        // Check if current lesson is completed
        const isCurrentCompleted = progressList && progressList.some(p =>
          p.lessonIndex === currentLessonIdx && p.completedAt && String(p.completedAt).trim() !== ''
        );

        // Check if ALL lessons are completed
        const totalLessons = courseData.lessons.length;
        const completedCount = progressList ? progressList.filter(p =>
          p.completedAt && String(p.completedAt).trim() !== ''
        ).length : 0;
        const allLessonsCompleted = completedCount === totalLessons;

        const nextLesson = courseData.lessons.find(l => l.index === currentLessonIdx + 1);

        let html = '';

        // 1. Complete Button (if not completed yet)
        if (!isCurrentCompleted) {
          html += `
            <button class="btn btn-red" style="width:100%; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center" 
               onclick="markCurrentLessonComplete('${courseData.courseCode}', ${currentLessonIdx}, '${courseData.courseName}')">
               <span>Ho√†n th√†nh b√†i h·ªçc</span>
               <i data-lucide="check-circle-2"></i>
            </button>
          `;
        } else {
          html += `
            <button class="btn" style="width:100%; margin-bottom:12px; border-color:var(--success); color:var(--success); background:rgba(34,197,94,0.1); cursor:default">
               <i data-lucide="check-circle-2" style="margin-right:8px"></i>
               ƒê√£ ho√†n th√†nh
            </button>
          `;
        }

        // 2. Next Button (if has next lesson) OR Congratulations (if ALL completed)
        if (nextLesson) {
          html += `
            <button class="btn" style="width:100%; background:var(--bg-800); border-color:var(--border); display:flex; justify-content:space-between; align-items:center" 
               onclick="openLesson('${courseData.courseName}', ${nextLesson.index})">
               <span>B√†i ti·∫øp theo</span>
               <i data-lucide="arrow-right"></i>
            </button>
          `;
        } else if (allLessonsCompleted) {
          // Last lesson AND ALL lessons completed ‚Üí Show congratulations
          html += `
            <button class="btn" style="width:100%; border-color:var(--success); color:var(--success); background:rgba(34,197,94,0.05); cursor:default">
               <i data-lucide="party-popper" style="margin-right:8px"></i>
               Ch√∫c m·ª´ng! ƒê√£ ho√†n th√†nh kh√≥a h·ªçc
            </button>
          `;
        }

        footerContainer.innerHTML = html;
        if (window.lucide) lucide.createIcons();
      }

      // 4. Update Sidebar List (Re-render to show ticks)
      const sidebarList = document.getElementById('sidebarLessonList');
      if (sidebarList) {
        renderSidebarList(courseData, currentLessonIdx, progressList);
      }
    }

    async function markCurrentLessonComplete(courseCode, lessonIndex, courseName) {
      try {
        // Get courseData from global storage
        let courseData = null;
        if (window._currentCourseData && window._currentCourseData[courseCode]) {
          courseData = window._currentCourseData[courseCode];
        } else {
          // Fallback: try to find in state.courses
          courseData = state.courses ? state.courses.find(c => c.courseCode === courseCode) : null;
        }

        if (!courseData || !courseData.lessons || !Array.isArray(courseData.lessons)) {
          console.error('Invalid courseData:', courseData);
          console.error('Available course data:', window._currentCourseData);
          showToast('L·ªói: D·ªØ li·ªáu kh√≥a h·ªçc kh√¥ng h·ª£p l·ªá', 'error');
          return;
        }

        // === OPTIMISTIC UPDATE ===
        // 1. Update UI IMMEDIATELY (kh√¥ng ch·ªù API)

        // Create fake progress entry for current lesson
        const now = new Date().toLocaleString('vi-VN');
        const optimisticProgress = {
          lessonIndex: lessonIndex,
          completedAt: now,
          videoTime: 0
        };

        // Get current progressList or create empty array
        let currentProgressList = [];
        if (window._cachedProgressList && window._cachedProgressList[courseCode]) {
          currentProgressList = [...window._cachedProgressList[courseCode]];
        }

        // Add or update the completed lesson
        const existingIndex = currentProgressList.findIndex(p => p.lessonIndex === lessonIndex);
        if (existingIndex >= 0) {
          currentProgressList[existingIndex] = optimisticProgress;
        } else {
          currentProgressList.push(optimisticProgress);
        }

        // Cache for next use
        if (!window._cachedProgressList) window._cachedProgressList = {};
        window._cachedProgressList[courseCode] = currentProgressList;

        // Update UI immediately with optimistic data
        updateLessonProgress(currentProgressList, lessonIndex, courseData);

        showToast('‚úÖ ƒê√£ ho√†n th√†nh b√†i h·ªçc!', 'success');

        const totalLessons = courseData.lessons.length;

        // === BACKGROUND SAVE + VERIFY COMPLETION ===
        saveLessonProgress(courseCode, lessonIndex, 0, true)
          .then(async () => {
            console.log('‚úÖ Saved to sheet successfully');

            // IMPORTANT: Fetch FRESH progress from server to verify completion
            const freshData = await callAPI('getProgress', {
              email: state.user.email,
              courseCode: courseCode
            });

            if (freshData.success && freshData.progress) {
              // Update cache with fresh data
              window._cachedProgressList[courseCode] = freshData.progress;

              // Count ACTUAL completed lessons from server
              const actualCompletedCount = freshData.progress.filter(p =>
                p.completedAt &&
                String(p.completedAt).trim() !== '' &&
                String(p.completedAt).trim() !== '0'
              ).length;

              console.log(`Completion check (from server): ${actualCompletedCount}/${totalLessons}`);

              // Check if ALL lessons completed
              if (actualCompletedCount >= totalLessons) {
                console.log('üéâ Course completed! Saving course completion...');

                const result = await callAPI('markCourseCompleted', {
                  email: state.user.email,
                  courseCode: courseCode,
                  courseName: courseName
                });

                if (result.success) {
                  showToast('üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh to√†n b·ªô kh√≥a h·ªçc!', 'success', 5000);
                  // Update UI to show congratulations
                  updateLessonProgress(freshData.progress, lessonIndex, courseData);
                } else {
                  console.error('Failed to mark course completed:', result.message);
                }
              }
            }
          })
          .catch(err => {
            console.error('‚ùå Failed to save:', err);
            showToast('C·∫£nh b√°o: L∆∞u ti·∫øn ƒë·ªô th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.', 'warning', 3000);
          });

      } catch (e) {
        console.error('Error in markCurrentLessonComplete:', e);
        showToast('L·ªói: ' + e.message, 'error');
      }
    }

    // H√†m Render ch√≠nh (Ch·ªâ render c·∫•u tr√∫c, update content v√†o Bento Tabs)
    function renderLessonShell(data, lessonIndex) {
      const lesson = data.lessons.find(function (x) { return x.index === lessonIndex; });
      const playerWrap = document.getElementById('playerWrap');
      const completeBtnContainer = document.getElementById('completeBtnContainer');
      const sidebarList = document.getElementById('sidebarLessonList');
      const courseTotalLessons = document.getElementById('courseTotalLessons');

      if (courseTotalLessons) courseTotalLessons.innerText = data.lessons.length + ' b√†i h·ªçc';

      warningCount = 0; devToolsDetected = false; blurCount = 0;

      // 1. Render Video (Stable Mode)
      if (lesson && lesson.videoEmbedUrl) {
        let secureUrl = lesson.videoEmbedUrl;
        // Optimize Google Drive links
        if (secureUrl.includes('drive.google.com')) {
          secureUrl = secureUrl.replace(/\/view.*$/, '/preview').replace(/\/edit.*$/, '/preview');
        }
        const separator = secureUrl.includes('?') ? '&' : '?';
        secureUrl += separator + 'rm=minimal';

        const watermarkText = state.user.email;

        playerWrap.innerHTML = `
          <div class="video-controls-blocker"></div>
          <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); 
               font-size:32px; color:rgba(255,255,255,0.08); font-weight:900; pointer-events:none; 
               z-index:5; user-select:none; white-space:nowrap; text-transform:uppercase; letter-spacing:4px;">
            ${escapeHtml(watermarkText)}
          </div>
          <iframe src="${secureUrl}" frameborder="0" allow="autoplay; encrypted-media" 
            sandbox="allow-scripts allow-same-origin allow-presentation" allowfullscreen 
            style="width:100%; height:100%; position:absolute; top:0; left:0; z-index:1;"></iframe>
        `;

        if (window.lucide) lucide.createIcons();

        // Anti Right Click
        playerWrap.oncontextmenu = function (e) { e.preventDefault(); return false; };

        // Save LastViewed
        saveLessonProgress(data.courseCode, lessonIndex, 0, false);
      } else {
        playerWrap.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted)">Kh√¥ng c√≥ video</div>';
      }

      // 2. Setup Bento Tab Contents (Overview)
      const titleEl = document.getElementById('lessonTitle');
      const descEl = document.getElementById('lessonDesc');
      if (titleEl) titleEl.innerText = `B√†i ${lesson.index}: ${lesson.lessonName}`;
      if (descEl) descEl.innerText = "N·ªôi dung chi ti·∫øt b√†i h·ªçc s·∫Ω s·ªõm ƒë∆∞·ª£c c·∫≠p nh·∫≠t.";

      // 3. Render Materials Tab
      const matArea = document.getElementById('materialsArea');
      if (lesson && lesson.materialUrl && matArea) {
        const lines = lesson.materialUrl.split('\n');
        let html = '';
        lines.forEach((line, idx) => {
          if (!line.trim()) return;
          let name = 'T√†i li·ªáu h·ªçc t·∫≠p ' + (idx + 1);
          let url = line.trim();
          if (line.includes('|')) { const parts = line.split('|'); name = parts[0].trim(); url = parts[1].trim(); }

          html += `
             <a href="${url}" target="_blank" class="material-card">
                <div class="file-icon">üìÑ</div>
                <div style="flex:1">
                   <div style="font-weight:600;color:var(--text-primary);font-size:14px">${escapeHtml(name)}</div>
                   <div style="font-size:12px;color:var(--text-muted)">Nh·∫•n ƒë·ªÉ t·∫£i xu·ªëng</div>
                </div>
                <i data-lucide="download" style="color:var(--text-muted)"></i>
             </a>
           `;
        });
        matArea.innerHTML = html;
        if (window.lucide) lucide.createIcons();
      } else if (matArea) {
        matArea.innerHTML = '<div class="muted">Kh√¥ng c√≥ t√†i li·ªáu n√†o.</div>';
      }

      // 4. Render Layout & Sidebar
      renderSidebarList(data, lessonIndex, []);

      // 5. Render Footer Actions (Placeholder)
      if (completeBtnContainer) {
        completeBtnContainer.innerHTML = '<button class="btn btn-red" style="width:100%;opacity:0.5">ƒêang t·∫£i...</button>';
      }
    }

    // Helper: Render Sidebar List (New Design)
    function renderSidebarList(data, currentLessonIdx, progressList) {
      const sidebarList = document.getElementById('sidebarLessonList');
      if (!sidebarList) return;

      // Defensive checks
      if (!data || !data.lessons || !Array.isArray(data.lessons)) {
        console.error('Invalid data in renderSidebarList:', data);
        return;
      }

      let sidebarHtml = '';
      data.lessons.forEach(l => {
        const isCurrent = l.index === currentLessonIdx;

        // Check if lesson is completed (more robust check)
        const isDone = progressList && progressList.some(p =>
          p.lessonIndex === l.index &&
          p.completedAt &&
          String(p.completedAt).trim() !== '' &&
          String(p.completedAt).trim() !== '0'
        );

        let statusIcon = '<div class="btn-circle" style="width:24px;height:24px;border:none;background:rgba(255,255,255,0.1)"><i data-lucide="play" size="12"></i></div>';
        let itemClass = 'playlist-item';

        if (isCurrent && isDone) {
          // Current lesson AND completed ‚Üí Show green check
          itemClass += ' active checked';
          statusIcon = '<div style="color:var(--success)"><i data-lucide="check-circle-2"></i></div>';
        } else if (isCurrent) {
          // Current lesson but not completed ‚Üí Show red bar chart
          itemClass += ' active';
          statusIcon = '<div style="color:var(--brand-red)"><i data-lucide="bar-chart-2"></i></div>';
        } else if (isDone) {
          // Not current but completed ‚Üí Show green check
          itemClass += ' checked';
          statusIcon = '<div style="color:var(--success)"><i data-lucide="check-circle-2"></i></div>';
        }

        sidebarHtml += `
          <div class="${itemClass}" onclick="openLesson('${data.courseName}', ${l.index})">
            <div class="playlist-status">${statusIcon}</div>
            <div class="playlist-info">
               <div class="playlist-title">B√†i ${l.index}: ${escapeHtml(l.lessonName)}</div>
               <div class="playlist-meta">${isDone ? 'ƒê√£ ho√†n th√†nh' : 'Ch∆∞a h·ªçc'}</div>
            </div>
          </div>
        `;
      });
      sidebarList.innerHTML = sidebarHtml;
      if (window.lucide) lucide.createIcons();
    }

    // Helper: L∆∞u progress √¢m th·∫ßm
    function saveLessonProgress(courseCode, lessonIndex, time, completed) {
      if (!courseCode || !state.user || !state.user.email) return Promise.reject('Invalid params');
      return callAPI('saveProgress', {
        email: state.user.email,
        courseCode: courseCode,
        lessonIndex: lessonIndex,
        videoTime: time,
        completed: completed
      });
    }

    // Action: B·∫•m ho√†n th√†nh
    async function markLessonComplete(lessonIndex, courseCode) {
      const btn = document.querySelector('.btn-complete');
      const originalText = btn.innerText;
      btn.innerText = 'ƒêang l∆∞u...';
      btn.disabled = true;

      try {
        await callAPI('saveProgress', {
          email: state.user.email,
          courseCode: courseCode,
          lessonIndex: lessonIndex,
          videoTime: 0,
          completed: true
        });

        btn.innerText = '‚úÖ ƒê√É HO√ÄN TH√ÄNH';
        btn.style.background = '#22c55e';

        // T·ª± ƒë·ªông chuy·ªÉn b√†i ti·∫øp theo sau 1s
        setTimeout(() => {
          const nextLesson = lessonIndex + 1;
          // Ki·ªÉm tra xem c√≥ b√†i ti·∫øp theo kh√¥ng (ƒë∆°n gi·∫£n, n·∫øu API openLesson fail th√¨ n√≥ s·∫Ω b√°o l·ªói, ko sao)
          openLesson(state.course, nextLesson);
        }, 1000);

      } catch (e) {
        alert('L·ªói l∆∞u ti·∫øn ƒë·ªô: ' + e);
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }

    function toImgUrl(driveUrl) {
      const id = (driveUrl.match(/\/d\/([a-zA-Z0-9_-]+)/) || [])[1];
      if (!id) return driveUrl;
      return 'https://drive.google.com/thumbnail?id=' + id + '&sz=w400';
    }

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, function (m) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
      });
    }

    // Convert Google Drive share URL to direct image URL
    function convertDriveUrl(url) {
      if (!url) return 'https://via.placeholder.com/800x450?text=Course';

      const str = String(url).trim();

      // Already a direct URL (not Google Drive)
      if (!str.includes('drive.google.com')) {
        return str;
      }

      // Extract file ID from various Google Drive URL formats
      let fileId = null;

      // Format: https://drive.google.com/file/d/{ID}/view...
      const match1 = str.match(/\/file\/d\/([^\/\?]+)/);
      if (match1) fileId = match1[1];

      // Format: https://drive.google.com/open?id={ID}
      const match2 = str.match(/[?&]id=([^&]+)/);
      if (!fileId && match2) fileId = match2[1];

      if (fileId) {
        // Return direct thumbnail URL
        return 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800';
      }

      // Can't parse, return original
      return str;
    }

    // --- TOAST NOTIFICATIONS HELPER ---
    window.showToast = function (message, type = 'info') {
      let container = document.querySelector('.toast-container');
      if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
      }

      const toast = document.createElement('div');
      toast.className = 'toast ' + type;

      const icon = type === 'success' ? '‚úÖ' : (type === 'error' ? '‚ùå' : (type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'));

      toast.innerHTML =
        '<div style="font-size: 20px;">' + icon + '</div>' +
        '<div style="flex:1; font-weight: 500; line-height: 1.4;">' + escapeHtml(message) + '</div>';

      // Click ƒë·ªÉ ƒë√≥ng s·ªõm
      toast.onclick = function () {
        toast.style.animation = 'fadeOutUp 0.3s forwards';
        setTimeout(function () { if (toast.parentNode) toast.remove(); }, 300);
      };

      container.appendChild(toast);

      // Auto remove sau 3s (ho·∫∑c 5s n·∫øu l√† error)
      const duration = type === 'error' ? 5000 : 3000;
      setTimeout(function () {
        if (toast.parentNode) {
          toast.style.animation = 'fadeOutUp 0.3s forwards';
          setTimeout(function () { if (toast.parentNode) toast.remove(); }, 300);
        }
      }, duration);
    };

    // --- COURSE REPORT MODAL (Premium Dashboard) ---
    let reportChartInstances = [];

    function createReportModal() {
      if (document.getElementById('reportModal')) return;

      // Add Chart.js if not loaded
      if (!window.Chart) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        document.head.appendChild(script);
      }

      const modalHTML = `
        <div id="reportModal" class="report-modal">
          <div class="report-container">
            <!-- Sidebar -->
            <aside class="report-sidebar">
              <div class="report-sidebar-header">
                <span class="report-logo">iaction<span style="color:var(--brand-red)">Admin</span></span>
              </div>
              <nav class="report-nav">
                <div class="report-nav-label">B√°o c√°o Kh√≥a h·ªçc</div>
                <div class="report-nav-item active" data-tab="overview" onclick="switchReportTab('overview')">
                  <i data-lucide="layout-dashboard"></i> T·ªïng quan
                </div>
                <div class="report-nav-item" data-tab="lessons" onclick="switchReportTab('lessons')">
                  <i data-lucide="book-open"></i> B√°o c√°o B√†i h·ªçc
                </div>
                <div class="report-nav-item" data-tab="students" onclick="switchReportTab('students')">
                  <i data-lucide="users"></i> B√°o c√°o H·ªçc vi√™n
                </div>
                <div class="report-nav-divider"></div>
                <div class="report-nav-item" onclick="closeReportModal()">
                  <i data-lucide="arrow-left"></i> ƒê√≥ng b√°o c√°o
                </div>
              </nav>
            </aside>
            
            <!-- Main Content -->
            <main class="report-main">
              <header class="report-header">
                <div>
                  <div class="report-breadcrumb">B√°o c√°o <i data-lucide="chevron-right" style="width:12px;height:12px"></i> <span id="reportCourseName">-</span></div>
                  <h1 id="reportPageTitle" class="report-title">T·ªïng quan hi·ªáu qu·∫£</h1>
                </div>
                <div class="report-header-actions">
                  <button onclick="closeReportModal()" class="report-btn-close"><i data-lucide="x"></i></button>
                </div>
              </header>
              
              <div class="report-content" id="reportContent">
                <div class="report-loading">
                  <i data-lucide="loader-2" class="spin"></i>
                  <span>ƒêang t·∫£i b√°o c√°o...</span>
                </div>
              </div>
            </main>
          </div>
        </div>
        
        <style>
          .report-modal { display:none; position:fixed; inset:0; background:#050507; z-index:9999; animation:fadeIn 0.3s ease; }
          .report-container { display:flex; height:100vh; font-family:inherit; }
          
          /* Sidebar */
          .report-sidebar { width:240px; background:#09090B; border-right:1px solid #1F1F23; display:flex; flex-direction:column; flex-shrink:0; }
          .report-sidebar-header { height:64px; display:flex; align-items:center; padding:0 20px; border-bottom:1px solid rgba(31,31,35,0.5); }
          .report-logo { font-size:18px; font-weight:900; letter-spacing:-0.5px; text-transform:uppercase; font-style:italic; color:white; }
          .report-nav { flex:1; padding:20px 12px; }
          .report-nav-label { font-size:10px; text-transform:uppercase; font-weight:700; color:#3F3F46; letter-spacing:0.1em; padding:0 12px 8px; }
          .report-nav-item { display:flex; align-items:center; gap:10px; padding:12px 16px; border-radius:8px; font-size:13px; font-weight:500; color:#71717A; cursor:pointer; transition:all 0.2s; margin-bottom:4px; border-left:3px solid transparent; }
          .report-nav-item:hover { background:#18181B; color:white; }
          .report-nav-item.active { background:linear-gradient(90deg, rgba(220,38,38,0.15) 0%, transparent 100%); border-left-color:#DC2626; color:white; font-weight:600; }
          .report-nav-item.active i { color:#DC2626; }
          .report-nav-item i { width:18px; height:18px; }
          .report-nav-divider { height:1px; background:#1F1F23; margin:16px; }
          
          /* Main */
          .report-main { flex:1; display:flex; flex-direction:column; overflow:hidden; background:#050507; }
          .report-header { height:64px; padding:0 32px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #1F1F23; background:rgba(5,5,7,0.8); backdrop-filter:blur(10px); }
          .report-breadcrumb { font-size:11px; color:#52525B; display:flex; align-items:center; gap:6px; margin-bottom:2px; }
          .report-title { font-size:16px; font-weight:700; color:white; display:flex; align-items:center; gap:8px; }
          .report-header-actions { display:flex; gap:8px; }
          .report-btn-close { width:32px; height:32px; border-radius:8px; background:#18181B; border:1px solid #27272A; display:flex; align-items:center; justify-content:center; color:#71717A; cursor:pointer; transition:all 0.2s; }
          .report-btn-close:hover { background:#27272A; color:white; }
          .report-btn-close i { width:16px; height:16px; }
          
          /* Content */
          .report-content { flex:1; overflow-y:auto; padding:24px 32px; }
          .report-loading { display:flex; flex-direction:column; align-items:center; justify-content:center; height:300px; gap:16px; color:#52525B; }
          .report-loading .spin { animation:spin 1s linear infinite; width:32px; height:32px; }
          @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
          
          /* Tab Panels */
          .report-tab { display:none; animation:fadeIn 0.3s ease; }
          .report-tab.active { display:block; }
          
          /* Cards */
          .report-card { background:#121216; border:1px solid #1F1F23; border-radius:16px; padding:20px; position:relative; overflow:hidden; transition:all 0.3s; }
          .report-card:hover { border-color:rgba(255,255,255,0.1); transform:translateY(-2px); }
          .report-card.blue { background:radial-gradient(circle at top right, rgba(59,130,246,0.15), rgba(18,18,22,0)); border-color:rgba(59,130,246,0.3); }
          .report-card.orange { background:radial-gradient(circle at top right, rgba(249,115,22,0.15), rgba(18,18,22,0)); border-color:rgba(249,115,22,0.3); }
          .report-card.green { background:radial-gradient(circle at top right, rgba(34,197,94,0.15), rgba(18,18,22,0)); border-color:rgba(34,197,94,0.3); }
          .report-card.purple { background:radial-gradient(circle at top right, rgba(168,85,247,0.15), rgba(18,18,22,0)); border-color:rgba(168,85,247,0.3); }
          .report-card-bg-icon { position:absolute; right:-10px; top:-10px; opacity:0.1; transition:opacity 0.3s; }
          .report-card:hover .report-card-bg-icon { opacity:0.2; }
          .report-card-value { font-size:36px; font-weight:900; color:white; margin-bottom:4px; position:relative; z-index:1; }
          .report-card-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.05em; display:flex; align-items:center; gap:6px; position:relative; z-index:1; }
          .report-card-label i { width:14px; height:14px; }
          .report-card-label.blue { color:#60A5FA; }
          .report-card-label.orange { color:#FB923C; }
          .report-card-label.green { color:#4ADE80; }
          .report-card-label.purple { color:#C084FC; }
          
          /* Grid */
          .report-grid-4 { display:grid; grid-template-columns:repeat(4, 1fr); gap:20px; margin-bottom:24px; }
          .report-grid-5 { display:grid; grid-template-columns:repeat(5, 1fr); gap:16px; margin-bottom:24px; }
          .report-grid-charts { display:grid; grid-template-columns:2fr 1fr; gap:20px; margin-bottom:24px; }
          @media (max-width: 1200px) { .report-grid-4, .report-grid-5 { grid-template-columns:repeat(2, 1fr); } .report-grid-charts { grid-template-columns:1fr; } }
          
          /* Chart Container */
          .report-chart-container { background:#121216; border:1px solid #1F1F23; border-radius:16px; padding:24px; }
          .report-chart-title { font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:0.05em; color:white; border-left:4px solid #DC2626; padding-left:12px; margin-bottom:20px; }
          .report-chart-title.blue { border-left-color:#3B82F6; }
          
          /* Badges */
          .report-badge { padding:4px 10px; border-radius:6px; font-size:10px; font-weight:700; text-transform:uppercase; display:inline-flex; align-items:center; gap:4px; letter-spacing:0.05em; }
          .report-badge.success { background:rgba(34,197,94,0.1); color:#22c55e; border:1px solid rgba(34,197,94,0.2); }
          .report-badge.warning { background:rgba(234,179,8,0.1); color:#eab308; border:1px solid rgba(234,179,8,0.2); }
          .report-badge.danger { background:rgba(239,68,68,0.1); color:#ef4444; border:1px solid rgba(239,68,68,0.2); }
          .report-badge.neutral { background:rgba(113,113,122,0.1); color:#a1a1aa; border:1px solid rgba(113,113,122,0.2); }
          
          /* Lesson Item */
          .report-lesson { padding:16px 0; border-bottom:1px solid #1F1F23; }
          .report-lesson:last-child { border-bottom:none; }
          .report-lesson-header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:8px; }
          .report-lesson-name { font-size:14px; font-weight:600; color:white; }
          .report-lesson-stats { display:flex; gap:20px; font-size:11px; color:#52525B; margin-top:4px; }
          .report-lesson-stats i { width:12px; height:12px; }
          .report-lesson-dropoff { font-size:11px; font-weight:700; }
          .report-lesson-bar { height:4px; background:#1F1F23; border-radius:2px; overflow:hidden; margin-top:10px; }
          .report-lesson-bar-fill { height:100%; border-radius:2px; position:relative; }
          .report-lesson-bar-fill::after { content:''; position:absolute; top:0; right:0; bottom:0; width:10px; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4)); }
          
          /* Table */
          .report-table { width:100%; border-collapse:collapse; }
          .report-table th { font-size:10px; text-transform:uppercase; font-weight:700; color:#52525B; letter-spacing:0.05em; padding:12px 16px; text-align:left; border-bottom:1px solid #1F1F23; }
          .report-table td { padding:16px; font-size:13px; color:#A1A1AA; border-bottom:1px solid rgba(31,31,35,0.5); }
          .report-table tr:hover { background:rgba(24,24,27,0.5); }
          .report-table .email { color:rgba(255,255,255,0.8); font-weight:500; }
          .report-table .name { color:white; font-weight:600; }
          .report-progress-mini { display:flex; align-items:center; gap:8px; }
          .report-progress-mini-bar { width:60px; height:6px; background:#18181B; border-radius:3px; overflow:hidden; }
          .report-progress-mini-fill { height:100%; border-radius:3px; }
        </style>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function switchReportTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
      // Remove active from nav
      document.querySelectorAll('.report-nav-item').forEach(n => n.classList.remove('active'));

      // Show selected tab
      const tab = document.getElementById('report-tab-' + tabName);
      if (tab) tab.classList.add('active');

      // Activate nav item
      const nav = document.querySelector(`.report-nav-item[data-tab="${tabName}"]`);
      if (nav) nav.classList.add('active');

      // Update title
      const titles = { overview: 'T·ªïng quan hi·ªáu qu·∫£', lessons: 'B√°o c√°o chi ti·∫øt B√†i h·ªçc', students: 'Qu·∫£n l√Ω H·ªçc vi√™n' };
      document.getElementById('reportPageTitle').textContent = titles[tabName] || 'B√°o c√°o';

      // Reinit icons
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    async function openCourseReport(courseName, courseCode, event) {
      if (event) event.stopPropagation();

      createReportModal();
      const modal = document.getElementById('reportModal');
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';

      // Set course name in breadcrumb
      document.getElementById('reportCourseName').textContent = courseName;

      try {
        const data = await callAPI('getCourseReport', { courseCode: courseCode });

        if (data.success) {
          renderCourseReport(data.report, courseName);
        } else {
          document.getElementById('reportContent').innerHTML = `
            <div class="report-loading" style="color:#ef4444">
              <i data-lucide="alert-circle" style="width:48px;height:48px"></i>
              <span>L·ªói: ${escapeHtml(data.message || 'Kh√¥ng th·ªÉ t·∫£i b√°o c√°o')}</span>
            </div>
          `;
          if (typeof lucide !== 'undefined') lucide.createIcons();
        }
      } catch (err) {
        console.error('Report error:', err);
        document.getElementById('reportContent').innerHTML = `
          <div class="report-loading" style="color:#ef4444">
            <i data-lucide="wifi-off" style="width:48px;height:48px"></i>
            <span>L·ªói k·∫øt n·ªëi: ${escapeHtml(err.message)}</span>
          </div>
        `;
        if (typeof lucide !== 'undefined') lucide.createIcons();
      }
    }

    function renderCourseReport(report, courseName) {
      window._currentReport = report; // Store for detail view access
      const content = document.getElementById('reportContent');
      const completionRate = report.totalStudents > 0 ? Math.round((report.completedStudents / report.totalStudents) * 100) : 0;

      // Status helper
      const getStatus = (s) => {
        if (s.progress >= 100) return { badge: 'success', icon: 'check', text: 'Ho√†n th√†nh' };
        // Active: Activity within 7 days (even if progress is 0%)
        if (s.daysSinceLastActivity <= 7) return { badge: 'warning', icon: 'book-open', text: 'ƒêang h·ªçc (Active)' };
        // Dormant: Has started (has lastActivity) but inactive > 7 days
        if (s.lastActivity) return { badge: 'neutral', icon: 'moon', text: 'Ng·ªß ƒë√¥ng' };
        return { badge: 'danger', icon: 'circle', text: 'Ch∆∞a b·∫Øt ƒë·∫ßu' };
      };

      // Calculate distribution for chart
      const notStartedPct = report.totalStudents > 0 ? Math.round((report.notStartedStudents / report.totalStudents) * 100) : 0;
      const activePct = report.totalStudents > 0 ? Math.round((report.activeStudents / report.totalStudents) * 100) : 0;
      const completedPct = report.totalStudents > 0 ? Math.round((report.completedStudents / report.totalStudents) * 100) : 0;

      content.innerHTML = `
        <!-- TAB 1: OVERVIEW -->
        <div id="report-tab-overview" class="report-tab active">
          <!-- Big Metric Cards -->
          <div class="report-grid-4">
            <div class="report-card blue">
              <div class="report-card-bg-icon"><i data-lucide="users" style="width:80px;height:80px;color:#3B82F6"></i></div>
              <div class="report-card-value">${report.totalStudents}</div>
              <div class="report-card-label blue"><i data-lucide="users"></i> T·ªïng h·ªçc vi√™n</div>
            </div>
            <div class="report-card orange">
              <div class="report-card-bg-icon"><i data-lucide="book-open" style="width:80px;height:80px;color:#F97316"></i></div>
              <div class="report-card-value">${report.activeStudents}</div>
              <div class="report-card-label orange"><i data-lucide="book-open"></i> ƒêang h·ªçc</div>
            </div>
            <div class="report-card green">
              <div class="report-card-bg-icon"><i data-lucide="check-circle" style="width:80px;height:80px;color:#22C55E"></i></div>
              <div class="report-card-value">${report.completedStudents}</div>
              <div class="report-card-label green"><i data-lucide="check-circle"></i> Ho√†n th√†nh</div>
            </div>
            <div class="report-card purple">
              <div class="report-card-bg-icon"><i data-lucide="trending-up" style="width:80px;height:80px;color:#A855F7"></i></div>
              <div class="report-card-value">${completionRate}%</div>
              <div class="report-card-label purple"><i data-lucide="activity"></i> T·ª∑ l·ªá ho√†n th√†nh</div>
            </div>
          </div>
          
          <!-- Secondary Stats -->
          <div class="report-grid-5">
            <div class="report-card" style="text-align:center">
              <div style="font-size:24px;font-weight:700;color:white;margin-bottom:4px">${report.notStartedStudents || 0}</div>
              <div style="font-size:10px;color:#52525B;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:4px"><i data-lucide="circle" style="width:12px;height:12px"></i> Ch∆∞a b·∫Øt ƒë·∫ßu</div>
            </div>
            <div class="report-card" style="text-align:center">
              <div style="font-size:24px;font-weight:700;color:white;margin-bottom:4px">${report.dormantStudents || 0}</div>
              <div style="font-size:10px;color:#52525B;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:4px"><i data-lucide="moon" style="width:12px;height:12px"></i> Ng·ªß ƒë√¥ng</div>
            </div>
            <div class="report-card" style="text-align:center">
              <div style="font-size:24px;font-weight:700;color:white;margin-bottom:4px">${report.averageProgress || 0}%</div>
              <div style="font-size:10px;color:#52525B;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:4px"><i data-lucide="bar-chart-2" style="width:12px;height:12px"></i> Ti·∫øn ƒë·ªô TB</div>
            </div>
            <div class="report-card" style="text-align:center">
              <div style="font-size:24px;font-weight:700;color:white;margin-bottom:4px">${report.totalLessons}</div>
              <div style="font-size:10px;color:#52525B;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:4px"><i data-lucide="list" style="width:12px;height:12px"></i> T·ªïng b√†i h·ªçc</div>
            </div>
            <div class="report-card" style="text-align:center;border-color:rgba(34,197,94,0.2);background:rgba(34,197,94,0.05)">
              <div style="font-size:24px;font-weight:700;color:#22c55e;margin-bottom:4px">${report.completionsThisWeek || 0}</div>
              <div style="font-size:10px;color:#22c55e;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:4px"><i data-lucide="calendar" style="width:12px;height:12px"></i> Xong tu·∫ßn n√†y</div>
            </div>
          </div>
          
          <!-- Charts -->
          <div class="report-grid-charts">
            <div class="report-chart-container">
              <div class="report-chart-title">Ho·∫°t ƒë·ªông h·ªçc t·∫≠p</div>
              <div style="height:250px"><canvas id="reportActivityChart"></canvas></div>
            </div>
            <div class="report-chart-container">
              <div class="report-chart-title blue">Ph√¢n b·ªï ti·∫øn ƒë·ªô</div>
              <div style="height:200px;display:flex;align-items:center;justify-content:center;position:relative">
                <canvas id="reportDistChart"></canvas>
                <div style="position:absolute;text-align:center">
                  <div style="font-size:24px;font-weight:900;color:white">${report.totalStudents}</div>
                  <div style="font-size:10px;color:#52525B;text-transform:uppercase">T·ªîNG HV</div>
                </div>
              </div>
              <div style="margin-top:20px;padding:0 16px">
                <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;margin-bottom:8px">
                  <span style="display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:#ef4444"></span><span style="color:#52525B">Ch∆∞a b·∫Øt ƒë·∫ßu</span></span>
                  <span style="font-weight:700;color:white">${notStartedPct}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;margin-bottom:8px">
                  <span style="display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:#3b82f6"></span><span style="color:#52525B">ƒêang h·ªçc</span></span>
                  <span style="font-weight:700;color:white">${activePct}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px">
                  <span style="display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:#22c55e"></span><span style="color:#52525B">Ho√†n th√†nh</span></span>
                  <span style="font-weight:700;color:white">${completedPct}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- TAB 2: LESSONS -->
        <div id="report-tab-lessons" class="report-tab">
          <div class="report-card" style="padding:32px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid #1F1F23">
              <div style="background:rgba(220,38,38,0.1);padding:10px;border-radius:10px">
                <i data-lucide="book-open" style="width:20px;height:20px;color:#DC2626"></i>
              </div>
              <div>
                <div style="font-size:16px;font-weight:700;color:white">Ph√¢n t√≠ch chi ti·∫øt b√†i h·ªçc</div>
                <div style="font-size:12px;color:#52525B">Theo d√µi m·ª©c ƒë·ªô t∆∞∆°ng t√°c v√† t·ª∑ l·ªá b·ªè d·ªü t·ª´ng b√†i</div>
              </div>
            </div>
            
            <div>
              ${report.lessonAnalytics && report.lessonAnalytics.length > 0 ? report.lessonAnalytics.map((l, i) => {
        const dropColor = l.dropOffRate > 50 ? '#ef4444' : l.dropOffRate > 25 ? '#f59e0b' : '#22c55e';
        const barWidth = l.views > 0 ? Math.round((l.completions / l.views) * 100) : 0;
        const barColor = barWidth === 100 ? '#22c55e' : barWidth > 50 ? '#f59e0b' : '#3F3F46';
        return `
                  <div class="report-lesson">
                    <div class="report-lesson-header">
                      <div>
                        <div class="report-lesson-name" style="display:flex;align-items:center;gap:8px">
                          <span>B√†i ${l.index}: ${escapeHtml(l.name)}</span>
                          <button class="btn-lesson-detail-mini" onclick="openLessonDetail(${i})" title="Xem chi ti·∫øt">
                            <i data-lucide="bar-chart-2" style="width:14px;height:14px"></i>
                          </button>
                        </div>
                        <div class="report-lesson-stats">
                          <span style="display:flex;align-items:center;gap:4px"><i data-lucide="eye" style="width:12px;height:12px"></i> ${l.views} l∆∞·ª£t xem</span>
                          <span style="display:flex;align-items:center;gap:4px"><i data-lucide="check-circle" style="width:12px;height:12px;color:#22c55e"></i> ${l.completions} ho√†n th√†nh</span>
                        </div>
                      </div>
                  </div>
                `;
      }).join('') : '<div style="text-align:center;color:#52525B;padding:40px">Ch∆∞a c√≥ d·ªØ li·ªáu b√†i h·ªçc</div>'}
            </div>
          </div>
        </div>
        
        <!-- TAB 3: STUDENTS -->
        <div id="report-tab-students" class="report-tab">
          <div class="report-card" style="padding:24px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
              <div style="display:flex;align-items:center;gap:12px">
                <div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:10px">
                  <i data-lucide="users" style="width:20px;height:20px;color:#3B82F6"></i>
                </div>
                <div>
                  <div style="font-size:16px;font-weight:700;color:white">Danh s√°ch h·ªçc vi√™n</div>
                  <div style="font-size:12px;color:#52525B">Qu·∫£n l√Ω ti·∫øn ƒë·ªô v√† tr·∫°ng th√°i h·ªçc t·∫≠p</div>
                </div>
              </div>
            </div>
            
            <div style="overflow-x:auto">
              <table class="report-table">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>T√™n</th>
                    <th>Ti·∫øn ƒë·ªô</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th style="text-align:right">L·∫ßn h·ªçc cu·ªëi</th>
                  </tr>
                </thead>
                <tbody>
                  ${report.students.length === 0 ?
          '<tr><td colspan="5" style="text-align:center;padding:40px;color:#52525B">Ch∆∞a c√≥ h·ªçc vi√™n n√†o</td></tr>' :
          report.students.map(s => {
            const st = getStatus(s);
            const barColor = s.progress >= 100 ? '#22c55e' : s.progress > 0 ? '#3b82f6' : '#27272A';
            return `
                        <tr>
                          <td class="email">${escapeHtml(s.email)}</td>
                          <td class="name">${escapeHtml(s.name || '-')}</td>
                          <td>
                            <div class="report-progress-mini">
                              <div class="report-progress-mini-bar">
                                <div class="report-progress-mini-fill" style="width:${s.progress}%;background:${barColor};${s.progress >= 100 ? 'box-shadow:0 0 5px #22c55e' : ''}"></div>
                              </div>
                              <span style="font-size:11px;font-weight:700;color:${s.progress > 0 ? 'white' : '#52525B'}">${s.progress}%</span>
                            </div>
                          </td>
                          <td><span class="report-badge ${st.badge}"><i data-lucide="${st.icon}" style="width:12px;height:12px"></i> ${st.text}</span></td>
                          <td style="text-align:right;font-family:monospace;font-size:12px">${s.lastActivity || '-'}</td>
                        </tr>
                      `;
          }).join('')
        }
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;

      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') lucide.createIcons();

      // Initialize Charts (with delay for Chart.js loading)
      setTimeout(() => initReportCharts(report), 100);
    }

    function initReportCharts(report) {
      // Destroy previous chart instances
      reportChartInstances.forEach(c => c.destroy());
      reportChartInstances = [];

      if (typeof Chart === 'undefined') {
        console.log('Chart.js not loaded yet');
        return;
      }

      // Activity Chart (Line)
      const activityCtx = document.getElementById('reportActivityChart');
      if (activityCtx) {
        const ctx = activityCtx.getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 250);
        gradient.addColorStop(0, 'rgba(34, 197, 94, 0.4)');
        gradient.addColorStop(1, 'rgba(34, 197, 94, 0)');

        const chart1 = new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'],
            datasets: [{
              label: 'B√†i h·ªçc ho√†n th√†nh',
              data: [Math.floor(Math.random() * 10), Math.floor(Math.random() * 15), Math.floor(Math.random() * 12),
              Math.floor(Math.random() * 20), Math.floor(Math.random() * 18), Math.floor(Math.random() * 25),
              report.completionsThisWeek || Math.floor(Math.random() * 30)],
              borderColor: '#22c55e',
              backgroundColor: gradient,
              borderWidth: 2,
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#050507',
              pointBorderColor: '#22c55e',
              pointRadius: 4,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false }, ticks: { color: '#52525B', font: { size: 10 } } },
              y: { grid: { color: '#1F1F23', borderDash: [5, 5] }, ticks: { color: '#52525B', font: { size: 10 } }, beginAtZero: true }
            }
          }
        });
        reportChartInstances.push(chart1);
      }

      // Distribution Chart (Doughnut)
      const distCtx = document.getElementById('reportDistChart');
      if (distCtx) {
        const chart2 = new Chart(distCtx, {
          type: 'doughnut',
          data: {
            labels: ['Ch∆∞a b·∫Øt ƒë·∫ßu', 'ƒêang h·ªçc', 'Ho√†n th√†nh'],
            datasets: [{
              data: [report.notStartedStudents || 0, report.activeStudents || 0, report.completedStudents || 0],
              backgroundColor: ['#ef4444', '#3b82f6', '#22c55e'],
              borderColor: '#121216',
              borderWidth: 4,
              hoverOffset: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: { legend: { display: false } }
          }
        });
        reportChartInstances.push(chart2);
      }
    }

    function closeReportModal() {
      const modal = document.getElementById('reportModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
      // Destroy charts
      reportChartInstances.forEach(c => c.destroy());
      reportChartInstances = [];
    }

    // --- SEARCH LOGIC ---
    let searchTimeout;
    async function handleSearch(keyword) {
      const dropdown = document.getElementById('searchDropdown');
      if (!dropdown) return;

      if (!keyword || keyword.trim().length < 2) {
        dropdown.classList.remove('active');
        return;
      }

      if (searchTimeout) clearTimeout(searchTimeout);

      searchTimeout = setTimeout(async () => {
        try {
          dropdown.classList.add('active');
          dropdown.innerHTML = '<div style="padding:16px;color:#888;text-align:center">‚è≥ ƒêang t√¨m...</div>';

          const result = await callAPI('search', { keyword });

          if (!result.success || !result.results || result.results.length === 0) {
            dropdown.innerHTML = '<div style="padding:16px;color:#888;text-align:center">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
            return;
          }

          let html = '';
          result.results.forEach(item => {
            const isLesson = item.type === 'lesson';
            const tag = isLesson ? 'B√ÄI H·ªåC' : 'KH√ìA H·ªåC';
            // Escape single quotes for onclick handler safely
            const safeCourseName = escapeHtml(item.courseName).replace(/'/g, "\\'");

            const clickAction = isLesson
              ? `openLesson('${safeCourseName}', ${item.lessonIndex})`
              : `openCourse('${safeCourseName}')`;

            const thumb = item.thumbnail ? toImgUrl(item.thumbnail) : '';
            const imgHtml = thumb ? `<img src="${thumb}">` : `<div style="width:40px;height:40px;background:#333;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:20px">${isLesson ? 'üé•' : 'üìö'}</div>`;

            html += `
                  <div class="search-item" onclick="${clickAction}; document.getElementById('searchDropdown').classList.remove('active')">
                     ${imgHtml}
                     <div class="search-meta">
                        <div class="search-title">${escapeHtml(item.title)}</div>
                        <div class="search-subtitle">${escapeHtml(item.subtitle)}</div>
                     </div>
                     <div class="search-tag">${tag}</div>
                  </div>
                `;
          });
          dropdown.innerHTML = html;

        } catch (e) {
          console.error(e);
          dropdown.innerHTML = '<div style="padding:12px;color:#ef4444;text-align:center">L·ªói t√¨m ki·∫øm</div>';
        }
      }, 400); // 400ms debounce
    }

    // Click outside to close search
    document.addEventListener('click', function (e) {
      const wrapper = document.querySelector('.search-wrapper');
      if (wrapper && !wrapper.contains(e.target)) {
        const dd = document.getElementById('searchDropdown');
        if (dd) dd.classList.remove('active');
      }
    });

    function openLessonDetail(index) {
      const report = window._currentReport;
      if (!report || !report.lessonAnalytics || !report.lessonAnalytics[index]) return;

      const l = report.lessonAnalytics[index];
      const details = l.details || [];

      // Parse date from "dd/MM/yyyy HH:mm" format
      function parseDate(str) {
        if (!str) return null;
        console.log('Parsing date:', str);
        // Flexible regex for d/m/y or dd/mm/yyyy with / or -
        const parts = str.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s*(\d{1,2})?:?(\d{1,2})?/);
        if (!parts) return null;
        return new Date(parts[3], parts[2] - 1, parts[1], parts[4] || 0, parts[5] || 0);
      }

      // Build chart data for given range
      function buildChartData(rangeDays) {
        const labels = [];
        const data = [];
        const now = new Date();
        now.setHours(23, 59, 59, 999);

        console.log('üîç [DEBUG] Building chart, range:', rangeDays, 'days, now:', now);
        console.log('üîç [DEBUG] Total details:', details.length, 'Sample:', details[0]);

        for (let i = rangeDays - 1; i >= 0; i--) {
          const d = new Date(now);
          d.setDate(now.getDate() - i);
          d.setHours(0, 0, 0, 0);
          const nextD = new Date(d);
          nextD.setDate(d.getDate() + 1);

          // Format label based on range
          const label = rangeDays <= 7
            ? d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' })
            : rangeDays <= 30
              ? d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' })
              : d.toLocaleDateString('vi-VN', { month: 'short' });
          labels.push(label);

          // Count activities in this day (use timestamp for reliable comparison)
          const matchedEntries = [];
          const count = details.filter(det => {
            if (!det.lastUpdateTs) {
              console.warn('‚ö†Ô∏è Missing lastUpdateTs:', det);
              return false;
            }
            const detDate = new Date(det.lastUpdateTs);
            const match = detDate >= d && detDate < nextD;
            if (match) {
              matchedEntries.push({ email: det.email, date: detDate.toLocaleString('vi-VN') });
            }
            return match;
          }).length;

          console.log(`üìä ${label} [${d.toLocaleDateString('vi-VN')}]: ${count} activities`);
          if (count > 0) {
            console.log('   üìù Matched entries:', matchedEntries);
          }
          data.push(count);
        }

        console.log('‚úÖ Labels:', labels, 'Data:', data);
        return { labels, data };
      }

      // Create modal if not exists
      if (!document.getElementById('lessonDetailModal')) {
        const div = document.createElement('div');
        div.id = 'lessonDetailModal';
        div.className = 'modal-overlay-2';
        div.innerHTML = `
          <div class="report-card" style="width:900px;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;padding:0;overflow:hidden;background:#09090b;border:1px solid #27272a">
            <div style="padding:16px 24px;border-bottom:1px solid #27272a;display:flex;justify-content:space-between;align-items:center;background:#18181b">
               <div>
                  <h3 style="margin:0;color:white;font-size:18px" id="ldTitle">Chi ti·∫øt b√†i h·ªçc</h3>
                  <div style="font-size:12px;color:#a1a1aa;margin-top:4px">Th·ªëng k√™ chi ti·∫øt h·ªçc vi√™n</div>
               </div>
               <button onclick="closeLessonDetail()" style="background:none;border:none;color:#52525b;cursor:pointer;padding:8px;border-radius:6px;transition:all 0.2s" onmouseover="this.style.background='#27272a';this.style.color='white'" onmouseout="this.style.background='none';this.style.color='#52525b'">
                  <i data-lucide="x" style="width:20px;height:20px"></i>
               </button>
            </div>
            <div style="flex:1;overflow-y:auto;padding:0" id="ldContent"></div>
          </div>
        `;
        document.body.appendChild(div);
      }

      // Populate Data
      document.getElementById('ldTitle').textContent = l.name;

      const views = l.views;
      const completes = l.completions;
      const viewingStudents = details.filter(d => !d.isCompleted);
      const completedStudents = details.filter(d => d.isCompleted);

      // Initial chart data (7 days)
      let currentRange = 7;
      let chartData = buildChartData(currentRange);

      const content = document.getElementById('ldContent');
      content.innerHTML = `
        <div style="padding:24px">
           <!-- Metrics Row -->
           <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px">
              <div style="background:#18181b;padding:16px;border-radius:12px;border:1px solid #27272a">
                 <div style="font-size:12px;color:#a1a1aa;margin-bottom:4px">T·ªïng l∆∞·ª£t xem</div>
                 <div style="font-size:24px;font-weight:700;color:white">${views}</div>
              </div>
              <div style="background:#18181b;padding:16px;border-radius:12px;border:1px solid #27272a">
                 <div style="font-size:12px;color:#a1a1aa;margin-bottom:4px">ƒêang xem</div>
                 <div style="font-size:24px;font-weight:700;color:#3b82f6">${viewingStudents.length}</div>
              </div>
              <div style="background:#18181b;padding:16px;border-radius:12px;border:1px solid #27272a">
                 <div style="font-size:12px;color:#a1a1aa;margin-bottom:4px">Ho√†n th√†nh</div>
                 <div style="font-size:24px;font-weight:700;color:#22c55e">${completedStudents.length}</div>
              </div>
              <div style="background:#18181b;padding:16px;border-radius:12px;border:1px solid #27272a">
                 <div style="font-size:12px;color:#a1a1aa;margin-bottom:4px">T·ª∑ l·ªá b·ªè d·ªü</div>
                 <div style="font-size:24px;font-weight:700;color:${l.dropOffRate > 50 ? '#ef4444' : '#f59e0b'}">${l.dropOffRate}%</div>
              </div>
           </div>

           <!-- Chart Section with Range Selector -->
           <div style="background:#18181b;border-radius:12px;border:1px solid #27272a;padding:20px;margin-bottom:24px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                 <div style="font-size:14px;font-weight:600;color:white">Xu h∆∞·ªõng truy c·∫≠p</div>
                 <div style="display:flex;gap:8px">
                    <button class="ld-range-btn active" data-range="7" style="padding:6px 12px;border-radius:6px;border:1px solid #3b82f6;background:rgba(59,130,246,0.2);color:#3b82f6;cursor:pointer;font-size:12px">7 ng√†y</button>
                    <button class="ld-range-btn" data-range="30" style="padding:6px 12px;border-radius:6px;border:1px solid #27272a;background:transparent;color:#71717a;cursor:pointer;font-size:12px">30 ng√†y</button>
                    <button class="ld-range-btn" data-range="90" style="padding:6px 12px;border-radius:6px;border:1px solid #27272a;background:transparent;color:#71717a;cursor:pointer;font-size:12px">3 th√°ng</button>
                 </div>
              </div>
              <div style="height:200px">
                 <canvas id="lessonTrendChart"></canvas>
              </div>
           </div>

           <!-- Student Tabs -->
           <div style="background:#18181b;border-radius:12px;border:1px solid #27272a;overflow:hidden">
              <div style="display:flex;border-bottom:1px solid #27272a">
                 <button class="ld-tab-btn active" data-tab="viewing" style="flex:1;padding:12px;background:rgba(59,130,246,0.1);border:none;color:#3b82f6;cursor:pointer;font-weight:600;font-size:13px">
                    ƒêang xem (${viewingStudents.length})
                 </button>
                 <button class="ld-tab-btn" data-tab="completed" style="flex:1;padding:12px;background:transparent;border:none;color:#71717a;cursor:pointer;font-weight:600;font-size:13px">
                    Ho√†n th√†nh (${completedStudents.length})
                 </button>
              </div>
              <div id="ldTabContent" style="max-height:300px;overflow-y:auto">
                 <!-- Tab content will be rendered here -->
              </div>
           </div>
        </div>
      `;

      // Render student list for a tab
      function renderStudentList(students, showCompletedAt) {
        if (students.length === 0) {
          return '<div style="padding:40px;text-align:center;color:#52525b">Kh√¥ng c√≥ h·ªçc vi√™n</div>';
        }
        return '<table style="width:100%;border-collapse:collapse;font-size:13px">' +
          '<thead style="background:#27272a;color:#a1a1aa;text-align:left;position:sticky;top:0">' +
          '<tr>' +
          '<th style="padding:12px 16px">H·ªçc vi√™n</th>' +
          '<th style="padding:12px 16px;text-align:right">' + (showCompletedAt ? 'Ho√†n th√†nh l√∫c' : 'C·∫≠p nh·∫≠t cu·ªëi') + '</th>' +
          '</tr>' +
          '</thead>' +
          '<tbody>' +
          students.map(d =>
            '<tr style="border-bottom:1px solid #27272a;color:#e4e4e7">' +
            '<td style="padding:12px 16px">' +
            '<div style="font-weight:500">' + escapeHtml(d.name) + '</div>' +
            '<div style="font-size:11px;color:#71717a">' + escapeHtml(d.email) + '</div>' +
            '</td>' +
            '<td style="padding:12px 16px;text-align:right;color:#71717a;font-family:monospace">' +
            (showCompletedAt ? (d.completedAt || '-') : (d.lastUpdate || '-')) +
            '</td>' +
            '</tr>'
          ).join('') +
          '</tbody>' +
          '</table>';
      }

      // Initial render viewing tab
      document.getElementById('ldTabContent').innerHTML = renderStudentList(viewingStudents, false);

      // Tab switching
      document.querySelectorAll('.ld-tab-btn').forEach(btn => {
        btn.onclick = function () {
          document.querySelectorAll('.ld-tab-btn').forEach(b => {
            b.classList.remove('active');
            b.style.background = 'transparent';
            b.style.color = '#71717a';
          });
          this.classList.add('active');
          this.style.background = this.dataset.tab === 'viewing' ? 'rgba(59,130,246,0.1)' : 'rgba(34,197,94,0.1)';
          this.style.color = this.dataset.tab === 'viewing' ? '#3b82f6' : '#22c55e';

          document.getElementById('ldTabContent').innerHTML = this.dataset.tab === 'viewing'
            ? renderStudentList(viewingStudents, false)
            : renderStudentList(completedStudents, true);
        };
      });

      // Chart init & range switching
      function initChart(labels, data) {
        const ctx = document.getElementById('lessonTrendChart').getContext('2d');
        if (window.lessonChartInstance) window.lessonChartInstance.destroy();

        window.lessonChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'L∆∞·ª£t t∆∞∆°ng t√°c',
              data: data,
              backgroundColor: '#3b82f6',
              borderRadius: 4,
              barThickness: labels.length > 30 ? 8 : labels.length > 14 ? 12 : 20
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false }, ticks: { color: '#71717a', maxRotation: 45 } },
              y: { grid: { color: '#27272a' }, ticks: { color: '#71717a', stepSize: 1 } }
            }
          }
        });
      }

      initChart(chartData.labels, chartData.data);

      // Range button click handlers
      document.querySelectorAll('.ld-range-btn').forEach(btn => {
        btn.onclick = function () {
          document.querySelectorAll('.ld-range-btn').forEach(b => {
            b.classList.remove('active');
            b.style.border = '1px solid #27272a';
            b.style.background = 'transparent';
            b.style.color = '#71717a';
          });
          this.classList.add('active');
          this.style.border = '1px solid #3b82f6';
          this.style.background = 'rgba(59,130,246,0.2)';
          this.style.color = '#3b82f6';

          const range = parseInt(this.dataset.range);
          const newData = buildChartData(range);
          initChart(newData.labels, newData.data);
        };
      });

      document.getElementById('lessonDetailModal').style.display = 'flex';
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function closeLessonDetail() {
      const m = document.getElementById('lessonDetailModal');
      if (m) m.style.display = 'none';
      if (window.lessonChartInstance) {
        window.lessonChartInstance.destroy();
        window.lessonChartInstance = null;
      }
    }


    // Init - Optimized (renderHome handles profile sync internally)
    (async function init() {
      if (checkAuth()) {
        console.log('üöÄ Init: User authenticated, rendering...');

        const urlParams = new URLSearchParams(window.location.search);
        const initialView = urlParams.get('view');
        const initialTab = urlParams.get('tab') || 'overview';
        const initialCourse = urlParams.get('course');
        const initialLesson = parseInt(urlParams.get('lesson')) || 0;

        // Check if dashboard view requested
        if (initialView === 'dashboard') {
          showLoading();
          await syncUserProfile();
          hideLoading();

          // Only teachers can access dashboard
          if (isTeacher) {
            renderAdminDashboard(initialTab);
          } else {
            renderHome();
          }
        } else if (initialCourse) {
          // N·∫øu c√≥ course/lesson trong URL, c·∫ßn sync profile tr∆∞·ªõc
          showLoading();
          await syncUserProfile();
          hideLoading();

          if (initialLesson > 0) {
            openLesson(initialCourse, initialLesson);
          } else {
            openCourse(initialCourse);
          }
        } else {
          // ƒêi th·∫≥ng v√†o renderHome (ƒë√£ t·ªëi ∆∞u v·ªõi 1 API call)
          renderHome();
        }
      } else {
        renderLogin();
      }
    })();
  </script>

</body>

</html>